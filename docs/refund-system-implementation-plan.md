# –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–∏—Å—Ç–µ–º—ã –≤–æ–∑–≤—Ä–∞—Ç–∞ —Å—Ä–µ–¥—Å—Ç–≤

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-01-27  
**–û—Å–Ω–æ–≤–∞–Ω–∏–µ:** [–ê–Ω–∞–ª–∏–∑ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã –≤–æ–∑–≤—Ä–∞—Ç–∞ —Å—Ä–µ–¥—Å—Ç–≤](./refund-system-readiness-analysis.md)

---

## üìã –û–±–∑–æ—Ä –ø–ª–∞–Ω–∞

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –ø–æ—ç—Ç–∞–ø–Ω—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –≤—Å–µ—Ö –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —Å–∏—Å—Ç–µ–º—ã –≤–æ–∑–≤—Ä–∞—Ç–∞ —Å—Ä–µ–¥—Å—Ç–≤. –ü–ª–∞–Ω —Ç–æ–ª—å–∫–æ –≤–∫–ª—é—á–∞—é—Ç —Ñ—É–Ω–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –µ—â–µ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –∏–ª–∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã —á–∞—Å—Ç–∏—á–Ω–æ.

**–û–±—â–µ–µ –≤—Ä–µ–º—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:** ~25-35 —á–∞—Å–æ–≤

---

## üéØ –ü–æ—Ä—è–¥–æ–∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π)

1. **–≠—Ç–∞–ø 1:** –î–æ—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –∑–∞—è–≤–ª–µ–Ω–∏—è –Ω–∞ –≤–æ–∑–≤—Ä–∞—Ç (4-6 —á–∞—Å–æ–≤)
2. **–≠—Ç–∞–ø 2:** –°–∏—Å—Ç–µ–º–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞ (8-12 —á–∞—Å–æ–≤)
3. **–≠—Ç–∞–ø 3:** –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –≤—ã–≤–æ–¥–∞ —Å—Ä–µ–¥—Å—Ç–≤ (12-16 —á–∞—Å–æ–≤)
4. **–≠—Ç–∞–ø 4:** –û–ø–ª–∞—Ç–∞ –∑–∞ —É—Å–ª—É–≥–∏ (2 —á–∞—Å–∞ - –≤–∞—Ä–∏–∞–Ω—Ç A)

---

# –≠—Ç–∞–ø 1: –î–æ—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –∑–∞—è–≤–ª–µ–Ω–∏—è –Ω–∞ –≤–æ–∑–≤—Ä–∞—Ç

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –í—ã—Å–æ–∫–∏–π  
**–í—Ä–µ–º—è:** 4-6 —á–∞—Å–æ–≤  
**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** –ù–µ—Ç

---

## –°—Ç–∞–¥–∏—è 1.1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

**–í—Ä–µ–º—è:** 1-1.5 —á–∞—Å–∞

### –ó–∞–¥–∞—á–∏:

- [ ] –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª–µ–π –≤ —Ç–∞–±–ª–∏—Ü—É `internal_requests`
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –§–ò–û –∏–ª–∏ —Ä–∞–∑–¥–µ–ª–∏—Ç—å –Ω–∞ –§–∞–º–∏–ª–∏—è/–ò–º—è/–û—Ç—á–µ—Å—Ç–≤–æ
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ –¥–ª—è —Å—É–º–º—ã –ø–æ—Ç–µ—Ä—è–Ω–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤
- [ ] –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ (—á–µ–∫–æ–≤)

### –§–∞–π–ª—ã:

**–°–æ–∑–¥–∞—Ç—å:** `lib/database/migrations/add-refund-request-fields.sql`

```sql
-- Add fields to internal_requests table for refund functionality
ALTER TABLE internal_requests
ADD COLUMN IF NOT EXISTS full_name VARCHAR(255),
ADD COLUMN IF NOT EXISTS first_name VARCHAR(100),
ADD COLUMN IF NOT EXISTS last_name VARCHAR(100),
ADD COLUMN IF NOT EXISTS middle_name VARCHAR(100),
ADD COLUMN IF NOT EXISTS lost_amount DECIMAL(20, 8),
ADD COLUMN IF NOT EXISTS lost_amount_currency VARCHAR(10) DEFAULT 'USD';

-- Create table for storing uploaded files (receipts, documents)
CREATE TABLE IF NOT EXISTS request_files (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  request_id VARCHAR(50) NOT NULL,
  file_name VARCHAR(255) NOT NULL,
  file_path VARCHAR(500) NOT NULL,
  file_size BIGINT NOT NULL,
  file_type VARCHAR(100) NOT NULL,
  uploaded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (request_id) REFERENCES internal_requests(id) ON DELETE CASCADE
);

CREATE INDEX IF NOT EXISTS idx_request_files_request_id ON request_files(request_id);

-- Add comment
COMMENT ON COLUMN internal_requests.full_name IS 'Full name for refund requests (can be used instead of separate name fields)';
COMMENT ON COLUMN internal_requests.lost_amount IS 'Amount of lost funds that user wants to recover';
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞:

- [ ] –ú–∏–≥—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è
- [ ] –¢–∞–±–ª–∏—Ü–∞ `request_files` —Å–æ–∑–¥–∞–Ω–∞
- [ ] –ü–æ–ª—è –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ `internal_requests`

---

## –°—Ç–∞–¥–∏—è 1.2: API –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤

**–í—Ä–µ–º—è:** 1.5-2 —á–∞—Å–∞

### –ó–∞–¥–∞—á–∏:

- [ ] –°–æ–∑–¥–∞—Ç—å API endpoint –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é —Ñ–∞–π–ª–æ–≤ (—Ç–∏–ø, —Ä–∞–∑–º–µ—Ä)
- [ ] –°–æ—Ö—Ä–∞–Ω—è—Ç—å —Ñ–∞–π–ª—ã –ª–æ–∫–∞–ª—å–Ω–æ –∏–ª–∏ –≤ –æ–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
- [ ] –°–æ—Ö—Ä–∞–Ω—è—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª–æ–≤ –≤ –ë–î

### –§–∞–π–ª—ã:

**–°–æ–∑–¥–∞—Ç—å:** `app/api/upload/receipt/route.ts`

```typescript
import { NextRequest, NextResponse } from "next/server";
import { writeFile, mkdir } from "fs/promises";
import { join } from "path";
import { query } from "@/lib/database/db";

const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB
const ALLOWED_FILE_TYPES = [
  "image/jpeg",
  "image/png",
  "image/jpg",
  "application/pdf",
  "image/webp",
];

export async function POST(request: NextRequest) {
  try {
    const formData = await request.formData();
    const file = formData.get("file") as File;
    const requestId = formData.get("requestId") as string;

    if (!file || !requestId) {
      return NextResponse.json(
        { error: "File and requestId are required" },
        { status: 400 }
      );
    }

    // Validate file type
    if (!ALLOWED_FILE_TYPES.includes(file.type)) {
      return NextResponse.json(
        { error: "Invalid file type. Allowed: JPEG, PNG, PDF" },
        { status: 400 }
      );
    }

    // Validate file size
    Berlinif (file.size > MAX_FILE_SIZE) {
      return NextResponse.json(
        { error: "File size exceeds 10MB limit" },
        { status: 400 }
      );
    }

    // Create upload directory if it doesn't exist
    const uploadDir = join(process.cwd(), "public", "uploads", "receipts");
    await mkdir(uploadDir, { recursive: true });

    // Generate unique filename
    const timestamp = Date.now();
    const sanitizedFileName = file.name.replace(/[^a-zA-Z0-9.-]/g, "_");
    const fileName = `${timestamp}-${sanitizedFileName}`;
    const filePath = join(uploadDir, fileName);

    // Save file
    const bytes = await file.arrayBuffer();
    const buffer = Buffer.from(bytes);
    await writeFile(filePath, buffer);

    // Save file metadata to database
    const relativePath = `/uploads/receipts/${fileName}`;
    const result = await query(
      `INSERT INTO request_files (request_id, file_name, file_path, file_size, file_type)
       VALUES ($1, $2, $3, $4, $5)
       RETURNING id, file_name, file_path`,
      [requestId, file.name, relativePath, file.size, file.type]
    );

    return NextResponse.json({
      success: true,
      file: {
        id: result.rows[0].id,
        name: result.rows[0].file_name,
        path: result.rows[0].file_path,
      },
    });
  } catch (error) {
    console.error("Error uploading file:", error);
    return NextResponse.json(
      { error: "Failed to upload file" },
      { status: 500 }
    );
  }
}
```

**–°–æ–∑–¥–∞—Ç—å:** `lib/database/queries.ts` (–¥–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏)

```typescript
// Add to existing queries.ts file

export interface RequestFile {
  id: string;
  request_id: string;
  file_name: string;
  file_path: string;
  file_size: number;
  file_type: string;
  uploaded_at: Date;
}

export async function getRequestFiles(requestId: string): Promise<RequestFile[]> {
  const result = await query(
    "SELECT * FROM request_files WHERE request_id = $1 ORDER BY uploaded_at DESC",
    [requestId],
  );
  return result.rows;
}

export async function deleteRequestFile(fileId: string): Promise<void> {
  await query("DELETE FROM request_files WHERE id = $1", [fileId]);
}
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞:

- [ ] API –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ñ–∞–π–ª—ã
- [ ] –§–∞–π–ª—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
- [ ] –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ë–î
- [ ] –í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

## –°—Ç–∞–¥–∏—è 1.3: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã –∑–∞—è–≤–ª–µ–Ω–∏—è

**–í—Ä–µ–º—è:** 1.5-2 —á–∞—Å–∞

### –ó–∞–¥–∞—á–∏:

- [ ] –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—è: –§–∞–º–∏–ª–∏—è, –ò–º—è, –û—Ç—á–µ—Å—Ç–≤–æ (–∏–ª–∏ –ø–æ–ª–Ω–æ–µ –§–ò–û)
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ "–°—É–º–º–∞ –ø–æ—Ç–µ—Ä—è–Ω–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤"
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ (—á–µ–∫–∏)
- [ ] –û–±–Ω–æ–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é —Ñ–æ—Ä–º—ã
- [ ] –û–±–Ω–æ–≤–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É –¥–∞–Ω–Ω—ã—Ö –Ω–∞ API

### –§–∞–π–ª—ã:

**–ò–∑–º–µ–Ω–∏—Ç—å:** `components/forms/internal-request-form.tsx`

–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å `FormState`:

```typescript
interface FormState {
  requester: string;
  lastName?: string; // NEW
  firstName?: string; // NEW
  middleName?: string; // NEW
  fullName?: string; // NEW (alternative to separate fields)
  lostAmount?: string; // NEW
  department: string;
  requestType: string;
  description: string;
  priority: "low" | "normal" | "high";
  walletAddress: string;
  uploadedFiles?: File[]; // NEW
}
```

–î–æ–±–∞–≤–∏—Ç—å –≤ —Ñ–æ—Ä–º—É:

```typescript
// Add file upload component
<div className="space-y-2">
  <label className="text-sm font-medium">
    {t("internalForm.receipts.label")}
  </label>
  <input
    type="file"
    multiple
    accept="image/*,.pdf"
    onChange={(e) => {
      const files = Array.from(e.target.files || []);
      setForm((prev) => ({ ...prev, uploadedFiles: files }));
    }}
    className="..."
  />
  <p className="text-xs text-muted">
    {t("internalForm.receipts.hint")}
  </p>
</div>

// Add lost amount field
<div className="space-y-2">
  <label className="text-sm font-medium">
    {t("internalForm.lostAmount.label")}
  </label>
  <input
    type="number"
    step="0.01"
    min="0"
    value={form.lostAmount || ""}
    onChange={(e) => handleChange("lostAmount", e.target.value)}
    placeholder={t("internalForm.lostAmount.placeholder")}
    className="..."
  />
</div>

// Add name fields (choose one approach)
// Option 1: Full name (single field)
<div className="space-y-2">
  <label className="text-sm font-medium">
    {t("internalForm.fullName.label")}
  </label>
  <input
    type="text"
    value={form.fullName || ""}
    onChange={(e) => handleChange("fullName", e.target.value)}
    required
    className="..."
  />
</div>

// Option 2: Separate fields (last, first, middle)
<div className="grid grid-colsÁ∫∑Âëà-3 gap-4">
  <div>
    <label>{t("internalForm.lastName.label")}</label>
    <input type="text" value={form.lastName || ""} ... />
  </div>
  <div>
    <label>{t("internalForm.firstName.label")}</label>
    <input type="text" value={form.firstName || ""} ... />
  </div>
  <div>
    <label>{t("internalForm.middleName.label")}</label>
    <input type="text" value={form.middleName || ""} ... />
  </div>
</div>
```

–û–±–Ω–æ–≤–∏—Ç—å `handleSubmit`:

```typescript
const handleSubmit = async (event: React.FormEvent<HTMLFormElement>) => {
  event.preventDefault();

  // Validate new fields
  if (!form.fullName && (!form.firstName || !form.lastName)) {
    toast.error(t("internalForm.validation.fullNameRequired"));
    return;
  }

  if (!form.lostAmount || parseFloat(form.lostAmount) <= 0) {
    toast.error(t("internalForm.validation.lostAmountRequired"));
    return;
  }

  setIsSubmitting(true);

  try {
    // First, submit request
    const response = await fetch("/api/submit-request", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        ...form,
        walletAddress: form.walletAddress || address,
        userId: userId || undefined,
        email: email || undefined,
      }),
    });

    const data = await response.json();

    if (!response.ok) {
      throw new Error(data.error || "Failed to submit request");
    }

    // Then, upload files if any
    if (form.uploadedFiles && form.uploadedFiles.length > 0) {
      for (const file of form.uploadedFiles) {
        const formData = new FormData();
        formData.append("file", file);
        formData.append("requestId", data.requestId);

        await fetch("/api/upload/receipt", {
          method: "POST",
          body: formData,
        });
      }
    }

    triggerConfetti();
    toast.success(t("internalForm.success"));

    // Reset form
    setForm(initialState);

    // Dispatch event for investigation progress update
    window.dispatchEvent(new CustomEvent("requestSubmitted"));
  } catch (error) {
    console.error("Error submitting request:", error);
    toast.error(t("internalForm.error"));
  } finally {
    setIsSubmitting(false);
  }
};
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞:

- [ ] –í—Å–µ –Ω–æ–≤—ã–µ –ø–æ–ª—è –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ —Ñ–æ—Ä–º–µ
- [ ] –í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –§–∞–π–ª—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞—è–≤–∫–∏
- [ ] –î–∞–Ω–Ω—ã–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –Ω–∞ API

---

## –°—Ç–∞–¥–∏—è 1. )4: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ API –ø—Ä–∏–µ–º–∞ –∑–∞—è–≤–æ–∫

**–í—Ä–µ–º—è:** 0.5-1 —á–∞—Å

### –ó–∞–¥–∞—á–∏:

- [ ] –û–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å `RequestFormData` –≤ API
- [ ] –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –Ω–æ–≤—ã—Ö –ø–æ–ª–µ–π
- [ ] –û–±–Ω–æ–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `createInternalRequest`

### –§–∞–π–ª—ã:

**–ò–∑–º–µ–Ω–∏—Ç—å:** `app/api/submit-request/route.ts`

```typescript
interface RequestFormData {
  requester: string;
  lastName?: string;
  firstName?: string;
  middleName?: string;
  fullName?: string;
  lostAmount?: string;
  department: string;
  requestType: string;
  priority: string;
  description: string;
  walletAddress?: string;
  userId?: string;
  email?: string;
}

export async function POST(request: NextRequest) {
  try {
    const data: RequestFormData = await request.json();

    // Validate required fields (including new ones)
    if (!data.requester || !data.department || !data.requestType || !data.description) {
      return NextResponse.json({ error: "Missing required fields" }, { status: 400 });
    }

    if (!data.fullName && (!data.firstName || !data.lastName)) {
      return NextResponse.json({ error: "Full name or first/last name required" }, { status: 400 });
    }

    if (!data.lostAmount || parseFloat(data.lostAmount) <= 0) {
      return NextResponse.json({ error: "Lost amount must be greater than 0" }, { status: 400 });
    }

    // Generate request ID
    const requestId = `IR-${Date.now()}`;

    // Save to database with new fields
    try {
      await createInternalRequest({
        id: requestId,
        requester: data.requester,
        full_name:
          data.fullName || `${data.lastName} ${data.firstName} ${data.middleName || ""}`.trim(),
        first_name: data.firstName,
        last_name: data.lastName,
        middle_name: data.middleName,
        lost_amount: data.lostAmount ? parseFloat(data.lostAmount) : null,
        lost_amount_currency: "USD",
        department: data.department,
        request_type: data.requestType,
        priority: data.priority,
        description: data.description,
        email: data.email || undefined,
        wallet_address: data.walletAddress || undefined,
        user_id: data.userId,
      });
    } catch (dbError) {
      console.error("Error saving to database:", dbError);
      return NextResponse.json({ error: "Failed to save request to database" }, { status: 500 });
    }

    // ... rest of email sending logic ...

    return NextResponse.json({
      success: true,
      requestId,
    });
  } catch (error) {
    console.error("ÈáåÁ®ãError processing request:", error);
    return NextResponse.json({ error: "Internal server error" }, { status: 500 });
  }
}
```

**–ò–∑–º–µ–Ω–∏—Ç—å:** `lib/database/queries.ts`

```typescript
export interface CreateInternalRequestData {
  id: string;
  wallet_address?: string;
  requester: string;
  full_name?: string;
  first_name?: string;
  last_name?: string;
  middle_name?: string;
  lost_amount?: number;
  lost_amount_currency?: string;
  email?: string;
  department: string;
  request_type: string;
  priority: string;
  description: string;
  user_id?: string;
}

export async function createInternalRequest(
  data: CreateInternalRequestData,
): Promise<InternalRequest> {
  const result = await query(
    `INSERT INTO internal_requests
     (id, wallet_address, requester, full_name, first_name, last_name, middle_name,
      lost_amount, lost_amount_currency, email, department, request_type, priority,
      description, status, user_id)
     VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16)
     RETURNING *`,
    [
      data.id,
      data.wallet_address || null,
      data.requester,
      data.full_name || null,
      data.first_name || null,
      data.last_name || null,
      data.middle_name || null,
      data.lost_amount || null,
      data.lost_amount_currency || "USD",
      data.email || null,
      data.department,
      data.request_type,
      data.priority,
      data.description,
      "pending",
      data.user_id || null,
    ],
  );

  return result.rows[0];
}
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞:

- [ ] API –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –Ω–æ–≤—ã–µ –ø–æ–ª—è
- [ ] –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ë–î
- [ ] Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Å–æ–¥–µ—Ä–∂–∞—Ç –Ω–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é

---

## –ò—Ç–æ–≥–∏ –≠—Ç–∞–ø–∞ 1

**–ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**

- ‚úÖ –ü–æ–ª—è –¥–ª—è –§–ò–û (–ø–æ–ª–Ω–æ–µ –∏–ª–∏ —Ä–∞–∑–¥–µ–ª—å–Ω–æ–µ)
- ‚úÖ –ü–æ–ª–µ –¥–ª—è —Å—É–º–º—ã –ø–æ—Ç–µ—Ä—è–Ω–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤
- ‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ (—á–µ–∫–∏, –¥–æ–∫—É–º–µ–Ω—Ç—ã)
- ‚úÖ –•—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π API –∏ —Ñ–æ—Ä–º—ã

**–°–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø:** –°–∏—Å—Ç–µ–º–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞

---

# –≠—Ç–∞–ø 2: –°–∏—Å—Ç–µ–º–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –í—ã—Å–æ–∫–∏–π  
**–í—Ä–µ–º—è:** 8-12 —á–∞—Å–æ–≤  
**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** –≠—Ç–∞–ø 1 (–¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è lost_amount –∏–∑ –∑–∞—è–≤–æ–∫)

---

## –°—Ç–∞–¥–∏—è 2.1: –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –±–∞–ª–∞–Ω—Å–æ–≤

**–í—Ä–µ–º—è:** 1 —á–∞—Å

### –ó–∞–¥–∞—á–∏:

- [ ] –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É `user_balances`
- [ ] –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ –æ–ø–µ—Ä–∞—Ü–∏–π —Å –±–∞–ª–∞–Ω—Å–æ–º
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã –∏ —Ç—Ä–∏–≥–≥–µ—Ä—ã

### –§–∞–π–ª—ã:

**–°–æ–∑–¥–∞—Ç—å:** `lib/database/migrations/create-user-balances.sql`

```sql
-- User Balances Table
CREATE TABLE IF NOT EXISTS user_balances (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id VARCHAR(255),
  wallet_address VARCHAR(255),
  email VARCHAR(255) NOT NULL,
  balance DECIMAL(20, 8) DEFAULT 0 NOT NULL,
  currency VARCHAR(10) DEFAULT 'TOKEN' NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

  -- Ensure one balance per user/wallet/email combination
  UNIQUE(user_id, wallet_address, email, currency)
);

-- Indexes
CREATE INDEX IF NOT EXISTS idx_user_balances_user_id ON user_balances(user_id);
CREATE INDEX IF NOT EXISTS idx_user_balances_wallet ON user_balances(wallet_address);
CREATE INDEX IF NOT EXISTS idx_user_balances_email ON user_balances(email);

-- Balance Transactions History Table
CREATE TABLE IF NOT EXISTS balance_transactions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  balance_id UUID NOT NULL REFERENCES user_balances(id) ON DELETE CASCADE,
  transaction_type VARCHAR(20) NOT NULL CHECK (transaction_type IN ('credit', 'debit')),
  amount DECIMAL(20, 8) NOT NULL,
  currency VARCHAR(10) DEFAULT 'TOKEN' NOT NULL,
  description TEXT,
  related_request_id VARCHAR(50),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

  FOREIGN KEY (related_request_id) REFERENCES internal_requests(id) ON DELETE SET NULL
);

-- Indexes for balance transactions
CREATE INDEX IF NOT EXISTS idx_balance_transactions_balance_id ON balance_transactions(balance_id);
CREATE INDEX IF NOT EXISTS idx_balance_transactions_created ON balance_transactions(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_balance_transactions_request ON balance_transactions(related_request_id);

-- Trigger to update updated_at
DROP TRIGGER IF EXISTS update_user_balances_updated_at ON user_balances;
CREATE TRIGGER update_user_balances_updated_at
  BEFORE UPDATE ON user_balances
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞:

- [ ] –¢–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞–Ω—ã —É—Å–ø–µ—à–Ω–æ
- [ ] –ò–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞–Ω—ã
- [ ] –¢—Ä–∏–≥–≥–µ—Ä—ã —Ä–∞–±–æ—Ç–∞—é—Ç

---

## –°—Ç–∞–¥–∏—è 2.2: –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞–ª–∞–Ω—Å–æ–º

**–í—Ä–µ–º—è:** 2-3 —á–∞—Å–∞

### –ó–∞–¥–∞—á–∏:

- [ ] –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞
- [ ] –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞
- [ ] –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞
- [ ] –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –æ–ø–µ—Ä–∞—Ü–∏–π

### –§–∞–π–ª—ã:

**–ò–∑–º–µ–Ω–∏—Ç—å:** `lib/database/queries.ts` (–¥–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏)

```typescript
// User Balance Interfaces
export interface UserBalance {
  id: string;
  user_id: string | null;
  wallet_address: string | null;
  email: string;
  balance: string;
  currency: string;
  created_at: Date;
  updated_at: Date;
}

export interface BalanceTransaction {
  id: string;
  balance_id: string;
  transaction_type: "credit" | "debit";
  amount: string;
  currency: string;
  description: string | null;
  related_request_id: string | null;
  created_at: Date;
}

// Get or create user balance
export async function getOrCreateUserBalance(params: {
  userId?: string;
  walletAddress?: string;
  email: string;
  currency?: string;
}): Promise<UserBalance> {
  const currency = params.currency || "TOKEN";

  // Try to find existing balance
  let queryStr = `
    SELECT * FROM user_balances
    WHERE email = $1 AND currency = $2
  `;
  const queryParams: any[] = [params.email, currency];

  if (params.userId) {
    queryStr += " AND user_id = $3";
    queryParams.push(params.userId);
  } else {
    queryStr += " AND user_id IS NULL";
  }

  if (params.walletAddress) {
    queryStr += ` AND wallet_address = $${queryParams.length + 1}`;
    queryParams.push(params.walletAddress);
  } else {
    queryStr += " AND wallet_address IS NULL";
  }

  const result = await query(queryStr, queryParams);

  if (result.rows.length > 0) {
    return result.rows[0];
  }

  // Create new balance
  const insertResult = await query(
    `INSERT INTO user_balances (user_id, wallet_address, email, balance, currency)
     VALUES ($1, $2, $3, $4, $5)
     RETURNING *`,
    [params.userId || null, params.walletAddress || null, params.email, 0, currency],
  );

  return insertResult.rows[0];
}

// Get user balance
export async function getUserBalance(params: {
  userId?: string;
  walletAddress?: string;
  email: string;
}): Promise<UserBalance | null> {
  const balance = await getOrCreateUserBalance(params);
  return balance;
}

// Credit balance (add funds)
export async function creditBalance(params: {
  balanceId: string;
  amount: number;
  currency?: string;
  description?: string;
  relatedRequestId?: string;
}): Promise<UserBalance> {
  const client = await getClient();

  try {
    await client.query("BEGIN");

    // Update balance
    const updateResult = await client.query(
      `UPDATE user_balances
       SET balance = balance + $1, updated_at = CURRENT_TIMESTAMP
       WHERE id = $2
       RETURNING *`,
      [params.amount, params.balanceId],
    );

    if (updateResult.rows.length === 0) {
      throw new Error("Balance not found");
    }

    // Create transaction record
    await client.query(
      `INSERT INTO balance_transactions
       (balance_id, transaction_type, amount, currency, description, related_request_id)
       VALUES ($1, 'credit', $2, $3, $4, $5)`,
      [
        params.balanceId,
        params.amount,
        params.currency || "TOKEN",
        params.description || null,
        params.relatedRequestId || null,
      ],
    );

    await client.query("COMMIT");
    return updateResult.rows[0];
  } catch (error) {
    await client.query("ROLLBACK");
    throw error;
  } finally {
    client.release();
  }
}

// Debit balance (subtract funds)
export async function debitBalance(params: {
  balanceId: string;
  amount: number;
  currency?: string;
  description?: string;
  relatedRequestId?: string;
}): Promise<UserBalance> {
  const client = await getClient();

  try {
    await client.query("BEGIN");

    // Check balance
    const balanceResult = await client.query("SELECT balance FROM user_balances WHERE id = $1", [
      params.balanceId,
    ]);

    if (balanceResult.rows.length === 0) {
      throw new Error("Balance not found");
    }

    const currentBalance = parseFloat(balanceResult.rows[0].balance);
    if (currentBalance < params.amount) {
      throw new Error("Insufficient balance");
    }

    // Update balance
    const updateResult = await client.query(
      `UPDATE user_balances
       SET balance = balance - $1, updated_at = CURRENT_TIMESTAMP
       WHERE id = $2
       RETURNING *`,
      [params.amount, params.balanceId],
    );

    // Create transaction record
    await client.query(
      `INSERT INTO balance_transactions
       (balance_id, transaction_type, amount, currency, description, related_request_id)
       VALUES ($1, 'debit', $2, $3, $4, $5)`,
      [
        params.balanceId,
        params.amount,
        params.currency || "TOKEN",
        params.description || null,
        params.relatedRequestId || null,
      ],
    );

    await client.query("COMMIT");
    return updateResult.rows[0];
  } catch (error) {
    await client.query("ROLLBACK");
    throw error;
  } finally {
    client.release();
  }
}

// Get balance transactions history
export async function getBalanceTransactions(
  balanceId: string,
  limit: number = 50,
): Promise<BalanceTransaction[]> {
  const result = await query(
    `SELECT * FROM balance_transactions
     WHERE balance_id = $1
     ORDER BY created_at DESC
     LIMIT $2`,
    [balanceId, limit],
  );

  return result.rows;
}
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞:

- [ ] –§—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∞—Ç–æ–º–∞—Ä–Ω–æ
- [ ] –ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è

---

## –°—Ç–∞–¥–∏—è 2.3: API endpoints –¥–ª—è –±–∞–ª–∞–Ω—Å–∞

**–í—Ä–µ–º—è:** 2-3 —á–∞—Å–∞

### –ó–∞–¥–∞—á–∏:

- [ ] –°–æ–∑–¥–∞—Ç—å GET endpoint –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞
- [ ] –°–æ–∑–¥–∞—Ç—å POST endpoint –¥–ª—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ (–∞–¥–º–∏–Ω)
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –¥–ª—è –∞–¥–º–∏–Ω—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

### –§–∞–π–ª—ã:

**–°–æ–∑–¥–∞—Ç—å:** `app/api/balance/route.ts`

```typescript
import { NextRequest, NextResponse } from "next/server";
import { getServerSession } from "next-auth";
import { authOptions } from "@/lib/auth";
import {
  getUserBalance,
  creditBalance,
  getOrCreateUserBalance,
} from "@/lib/database/queries";

// GET /api/balance - Get user balance
export async function GET(request: NextRequest) {
  try {
    const session = await getServerSession(authOptions);
    const searchParams = request.nextUrl.searchParams;

    const walletAddress = searchParams.get("walletAddress");
    const email = searchParams.get("email");

    // Determine user identifier
    let userId: string | undefined;
    let userEmail: string;
    let userWallet: string | undefined;

    if (session?.user) {
      // OAuth user
      userId = session.user.id;
      userEmail = session.user.email || email || "";
    } else if (walletAddress) {
      // MetaMask user
      userWallet = walletAddress;
      userEmail = email || "";
    } else {
      return NextResponse.json(
        { error: "Authentication required" },
        { status: 401 }
      );
    }

    if (!userEmail) {
      return NextResponse.json(
        { error: "Email is required" },
        { status: 400 }
      );
    }

    const balance = await getUserBalance({
      userId,
      walletAddress: userWallet,
      email: userEmail,
    });

    if (!balance) {
      return NextResponse.json(
        { error: "Balance not found" },
        { status: 404 }
      );
    }

    return NextResponse.json({
      balance: parseFloat(balance.balance),
      currency: balance.currency happy,
      formattedBalance: parseFloat(balance.balance).toFixed(8),
    });
  } catch (error) {
    console.error("Error fetching balance:", error);
    return NextResponse.json(
      { error: "Failed to fetch balance" },
      { status: 500 }
    );
  }
}

// POST /api/balance - Add balance (admin only or automated)
export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { userId, walletAddress, email, amount, description, requestId } = body;

    // Validate required fields
    if (!email || !amount || amount <= 0) {
      return NextResponse.json(
        { error: "Email and amount (greater than 0) are required" },
        { status: 400 }
      );
    }

    // Get or create balance
    const balance = await getOrCreateUserBalance({
      userId,
      walletAddress,
      email,
    });

    // Credit balance
    const updatedBalance = await creditBalance({
      balanceId: balance.id,
      amount: parseFloat(„Åïamount.toString()),
      description: description || "Balance credited",
      relatedRequestId: requestId,
    });

    return NextResponse.json({
      success: true,
      balance: parseFloat(updatedBalance.balance),
      currency: updatedBalance.currency,
    });
  } catch (error) {
    console.error("Error crediting balance:", error);
    return NextResponse.json(
      { error: "Failed to credit balance" },
      { status: 500 }
    );
  }
}
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞:

- [ ] GET endpoint –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- [ ] POST endpoint –Ω–∞—á–∏—Å–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å
- [ ] –û—à–∏–±–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

## –°—Ç–∞–¥–∏—è 2.4: –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞

**–í—Ä–µ–º—è:** 2-3 —á–∞—Å–∞

### –ó–∞–¥–∞—á–∏:

- [ ] –°–æ–∑–¥–∞—Ç—å hook –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞
- [ ] –°–æ–∑–¥–∞—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞
- [ ] –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É

### –§–∞–π–ª—ã:

**–°–æ–∑–¥–∞—Ç—å:** `hooks/use-internal-balance.ts`

```typescript
import { useQuery } from "@tanstack/react-query";
import { useAccount } from "wagmi";
import { useAuth } from "./use-auth";

export function useInternalBalance() {
  const { address } = useAccount();
  const { userId, email, authType } = useAuth();

  return useQuery({
    queryKey: ["internalBalance", userId, address, email],
    queryFn: async () => {
      const params = new URLSearchParams();

      if (authType === "oauth" && email) {
        // OAuth user
        params.append("email", email);
      } else if (address) {
        // MetaMask user
        params.append("walletAddress", address);
        if (email) {
          params.append("email", email);
        }
      } else {
        throw new Error("User not authenticated");
      }

      const response = await fetch(`/api/balance?${params.toString()}`);

      if (!response.ok) {
        throw new Error("Failed to fetch balance");
      }

      return await response.json();
    },
    enabled: !!(userId || address) && !!email,
    refetchInterval: 30000, // Refetch every 30 seconds
  });
}
```

**–°–æ–∑–¥–∞—Ç—å:** `components/wallet/internal-balance-card.tsx`

```typescript
"use client";

import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { useInternalBalance } from "@/hooks/use-internal-balance";
import { useTranslation } from "@/hooks/use-translation";

export function InternalBalanceCard() {
  const { data, isLoading, error } = useInternalBalance();
  const t = useTranslation();

  if (error) {
    return (
      <Card>
        <CardHeader>
          <CardTitle>{t("wallet.internalBalance.title")}</CardTitle>
          <CardDescription>{t("wallet.internalBalance.error")}</CardDescription>
        </CardHeader>
      </Card>
    );
  }

  return (
    <Card>
      <CardHeader>
        <CardTitle>{t("wallet.internalBalance.title")}</CardTitle>
        <CardDescription>{t("wallet.internalBalance.description")}</CardDescription>
      </CardHeader>
      <CardContent>
        {isLoading ? (
          <div className="space-y-2">
            <div className="h-8 w-1/3 animate-pulse rounded bg-muted" />
            <div className="h-4 w-1/2 animate-pulse rounded bg-muted" />
          </div>
        ) : (
          <div className="space-y-2">
            <div className="text-3xl font-bold">
              {data?.formattedBalance || "0.00000000"} {data?.currency || "TOKEN"}
            </div>
            <p className="text-sm text-muted-foreground">
              {t("wallet.internalBalance.hint")}
            </p>
          </div>
        )}
      </CardContent>
    </Card>
  );
}
```

**–ò–∑–º–µ–Ω–∏—Ç—å:** `app/page.tsx` (–¥–æ–±–∞–≤–∏—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç)

```typescript
import { InternalBalanceCard } from "@/components/wallet/internal-balance-card-retention";

// –í —Å–µ–∫—Ü–∏–∏ token-balance –¥–æ–±–∞–≤–∏—Ç—å:
<section id="token-balance" className="flex flex-col gap-6">
  <BalanceCard />
  <InternalBalanceCard /> {/* NEW */}
  <div className="grid gap-6 md:grid-cols-2">
    <PriceTicker />
    <TaxCard />
  </div>
  <DexscreenerChart />
</section>
```

**–ò–∑–º–µ–Ω–∏—Ç—å:** `components/wallet/index.ts` (—ç–∫—Å–ø–æ—Ä—Ç)

```typescript
export { InternalBalanceCard } from "./internal-balance-card";
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞:

- [ ] Hook –ø–æ–ª—É—á–∞–µ—Ç –±–∞–ª–∞–Ω—Å
- [ ] –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –±–∞–ª–∞–Ω—Å
- [ ] –ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

---

## –°—Ç–∞–¥–∏—è 2.5: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –ø—Ä–∏ –æ–¥–æ–±—Ä–µ–Ω–∏–∏ –∑–∞—è–≤–∫–∏

**–í—Ä–µ–º—è:** 1-2 —á–∞—Å–∞

### –ó–∞–¥–∞—á–∏:

- [ ] –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –ø—Ä–∏ —Å—Ç–∞—Ç—É—Å–µ "completed"
- [ ] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `lost_amount` –∏–∑ –∑–∞—è–≤–∫–∏
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É, —á—Ç–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑

### –§–∞–π–ª—ã:

**–ò–∑–º–µ–Ω–∏—Ç—å:** `app/api/webhook/update-request/route.ts`

```typescript
import { creditBalance, getOrCreateUserBalance } from "@/lib/database/queries";

// –í —Ñ—É–Ω–∫—Ü–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –¥–æ–±–∞–≤–∏—Ç—å:

// Check if status changed to "completed"
if (newStatus === "completed" && oldStatus !== "completed") {
  // Get request details
  const request = await getInternalRequestById(requestId);

  if (request && request.lost_amount && request.lost_amount > 0) {
    try {
      // Determine user identifiers
      const userId = request.user_id || undefined;
      const walletAddress = request.wallet_address || undefined;
      const email = request.email;

      if (!email) {
        console.error("Cannot credit balance: no email in request");
      } else {
        // Get or create balance
        const balance = await getOrCreateUserBalance({
          userId,
          walletAddress,
          email,
        });

        // Credit balance
        await creditBalance({
          balanceId: balance.id,
          amount: parseFloat(request.lost_amount.toString()),
          description: `Balance credited from approved refund request ${requestId}`,
          relatedRequestId: requestId,
        });

        console.log(`Balance credited for request ${requestId}`);
      }
    } catch (error) {
      console.error(`Error crediting balance for request ${requestId}:`, error);
      // Don't fail the status update if balance credit fails
      // Log error for manual review
    }
  }
}
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞:

- [ ] –ü—Ä–∏ –æ–¥–æ–±—Ä–µ–Ω–∏–∏ –∑–∞—è–≤–∫–∏ –±–∞–ª–∞–Ω—Å –Ω–∞—á–∏—Å–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- [ ] –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
- [ ] –°—É–º–º–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç `lost_amount` –∏–∑ –∑–∞—è–≤–∫–∏

---

## –ò—Ç–æ–≥–∏ –≠—Ç–∞–ø–∞ 2

**–ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**

- ‚úÖ –¢–∞–±–ª–∏—Ü–∞ –±–∞–ª–∞–Ω—Å–æ–≤ –∏ –∏—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úÖ –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞–ª–∞–Ω—Å–æ–º
- ‚úÖ API endpoints –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞
- ‚úÖ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –ø—Ä–∏ –æ–¥–æ–±—Ä–µ–Ω–∏–∏ –∑–∞—è–≤–∫–∏

**–°–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø:** –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –≤—ã–≤–æ–¥–∞ —Å—Ä–µ–¥—Å—Ç–≤

---

# –≠—Ç–∞–ø 3: –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –≤—ã–≤–æ–¥–∞ —Å—Ä–µ–¥—Å—Ç–≤

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –í—ã—Å–æ–∫–∏–π  
**–í—Ä–µ–º—è:** 12-16 —á–∞—Å–æ–≤  
**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** –≠—Ç–∞–ø 2 (—Å–∏—Å—Ç–µ–º–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞)

---

## –°—Ç–∞–¥–∏—è 3.1: –¢–∞–±–ª–∏—Ü–∞ –∏—Å—Ç–æ—Ä–∏–∏ –≤—ã–≤–æ–¥–æ–≤

**–í—Ä–µ–º—è:** 1 —á–∞—Å

### –ó–∞–¥–∞—á–∏:

- [ ] –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É `withdrawals` –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ –≤—ã–≤–æ–¥–æ–≤
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã –∏ —Å–≤—è–∑–∏

### –§–∞–π–ª—ã:

**–°–æ–∑–¥–∞—Ç—å:** `lib/database/migrations/create-withdrawals-table.sql`

```sql
-- Withdrawals Table
CREATE TABLE IF NOT EXISTSÊúâ‰ª•‰∏ãwithdrawals (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id VARCHAR(255),
  wallet_address VARCHAR(255),
  email VARCHAR(255) NOT NULL,
  amount DECIMAL(20, 8) NOT NULL,
  currency VARCHAR(10) DEFAULT 'TOKEN' NOT NULL,
  to_wallet_address VARCHAR(255) NOT NULL,
  tx_hash VARCHAR(66), -- Blockchain transaction hash
  status VARCHAR(20) DEFAULT 'pending' NOT NULL CHECK (status IN ('pending', 'processing', 'completed', 'failed')),
  error_message TEXT,
  balance_transaction_id UUID REFERENCES balance_transactions(id),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Indexes
CREATE INDEX IF NOT EXISTS idx_withdrawals_user_id ON withdrawals(user_id);
CREATE INDEX IF NOT EXISTS idx_withdrawals_wallet ON withdrawals(wallet_address);
CREATE INDEX IF NOT EXISTS idx_withdrawals_email ON withdrawals(email);
CREATE INDEX IF NOT EXISTS idx GCCwithdrawals_status ON withdrawals(status);
CREATE INDEX IF NOT EXISTS idx_withdrawals_tx_hash ON withdrawals(tx_hash);
CREATE INDEX IF NOT EXISTS idx_withdrawals_created ON withdrawals(created_at DESC);

-- Trigger to update updated_at
DROP TRIGGER IF EXISTS update_withdrawals_updated_at ON withdrawals;
CREATE TRIGGER update_withdrawals_updated_at
  BEFORE UPDATE ON withdrawals
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞:

- [ ] –¢–∞–±–ª–∏—Ü–∞ —Å–æ–∑–¥–∞–Ω–∞
- [ ] –ò–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞–Ω—ã
- [ ] –¢—Ä–∏–≥–≥–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç

---

## –°—Ç–∞–¥–∏—è 3.2: –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≤—ã–≤–æ–¥–∞–º–∏

**–í—Ä–µ–º—è:** 2 —á–∞—Å–∞

### –ó–∞–¥–∞—á–∏:

- [ ] –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≤—ã–≤–æ–¥–∞
- [ ] –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –≤—ã–≤–æ–¥–æ–≤
- [ ] –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –≤—ã–≤–æ–¥–∞

### –§–∞–π–ª—ã:

**–ò–∑–º–µ–Ω–∏—Ç—å:** `lib/database/queries.ts` (–¥–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏)

```typescript
// Withdrawal Interfaces
export interface Withdrawal {
  id: string;
  user_id: string | null;
  wallet_address: string | null;
  email: string;
  amount: string;
  currency: string;
  to_wallet_address: string;
  tx_hash: string | null;
  status: "pending" | "processing" | "completed" | "failed";
  error_message: string | null;
  balance_transaction_id: string | null;
  created_at: Date;
  updated_at: Date;
}

export interface CreateWithdrawalData {
  userId?: string;
  walletAddress?: string;
  email: string;
  amount: number;
  currency?: string;
  toWalletAddress: string;
}

// Create withdrawal
export async function createWithdrawal(data: CreateWithdrawalData): Promise<Withdrawal> {
  const result = await query(
    `INSERT INTO withdrawals
     (user_id, wallet_address, email, amount, currency, to_wallet_address, status)
     VALUES ($1, $2, $3, $4, $5, $6, $7)
     RETURNING *`,
    [
      data.userId || null,
      data.walletAddress || null,
      data.email,
      data.amount,
      data.currency || "TOKEN",
      data.toWalletAddress,
      "pending",
    ],
  );

  return result.rows[0];
}

// Get withdrawals by user
export async function getWithdrawalsByUser(params: {
  userId?: string;
  walletAddress?: string;
  email: string;
  limit?: number;
}): Promise<Withdrawal[]> {
  let queryStr = `
    SELECT * FROM withdrawals
    WHERE email = $1
  `;
  const queryParams: any[] = [params.email];

  if (params.userId) {
    queryStr += " AND user_id = $2";
    queryParams.push(params.userId);
  } else if (params.walletAddress - only) {
    queryStr += " AND wallet_address = $2";
    queryParams.push(params.walletAddress);
  }

  queryStr += " ORDER BY created_at DESC LIMIT $3";
  queryParams.push(params.limit || 50);

  const result = await query(queryStr, queryParams);
  return result.rows;
}

// Update withdrawal status
export async function updateWithdrawalStatus(
  withdrawalId: string,
  status: "pending" | "processing" | "completed" | "failed",
  txHash?: string,
  errorMessage?: string,
): Promise<Withdrawal> {
  const result = await query(
    `UPDATE withdrawals
     SET status = $1, tx_hash = COALESCE($2, tx_hash),
         error_message = COALESCE($3, error_message),
         updated_at = CURRENT_TIMESTAMP
     WHERE id = $4
     RETURNING *`,
    [status, txHash || null, errorMessage || null, withdrawalId],
  );

  if (result.rows.length === 0) {
    throw new Error("Withdrawal not found");
  }

  return result.rows[0];
}

// Link withdrawal to balance transaction
export async function linkWithdrawalToBalanceTransaction(
  withdrawalId: string,
  balanceTransactionId: string,
): Promise<void> {
  await query("UPDATE withdrawals SET balance_transaction_id = $1 WHERE id = $2", [
    balanceTransactionId,
    withdrawalId,
  ]);
}
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞:

- [ ] –§—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] –í—ã–≤–æ–¥—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –≤ –ë–î
- [ ] –ò—Å—Ç–æ—Ä–∏—è –ø–æ–ª—É—á–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

## –°—Ç–∞–¥–∏—è 3.3: API endpoint –¥–ª—è –≤—ã–≤–æ–¥–∞

**–í—Ä–µ–º—è:** 3-4 —á–∞—Å–∞

### –ó–∞–¥–∞—á–∏:

- [ ] –°–æ–∑–¥–∞—Ç—å POST endpoint –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≤—ã–≤–æ–¥–∞
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –±–∞–ª–∞–Ω—Å–∞
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É —Ç–æ–∫–µ–Ω–æ–≤ (–∏–ª–∏ –ø–æ—Å—Ç–∞–≤–∏—Ç—å –≤ –æ—á–µ—Ä–µ–¥—å)

### –§–∞–π–ª—ã:

**–°–æ–∑–¥–∞—Ç—å:** `app/api/withdraw/route.ts`

```typescript
import { NextRequest, NextResponse } from "next/server";
import { getServerSession } from "next-auth";
import { authOptions } from "@/lib/auth";
import {
  getUserBalance,
  debitBalance,
  createWithdrawal,
  updateWithdrawalStatus,
  linkWithdrawalToBalanceTransaction,
} from "@/lib/database/queries";
import { parseUnits, formatUnits } from "viem";
import { TOKEN_CONFIG } from "@/config/token";

// POST /api/withdraw - Create withdrawal request
export async function POST(request: NextRequest) {
  try {
    const session = await getServerSession(authOptions);
    const body = await request.json();

    const { amount, toWalletAddress } = bodyÊú∫Ê≤π;

    // Validate input
    if (!amount || amount <= 0) {
      return NextResponse.json(
        { error: "Amount must be greater than 0" },
        { status: 400 }
      );
    }

    if (!toWalletAddress || !/^0x[a-fA-F0-9]{40}$/.test(toWalletAddress)) {
      return NextResponse.json(
        { error: "Valid wallet address is required" },
        { status: 400 }
      );
    }

    // Get user identifiers
    let userId: string | undefined;
    let userEmail: string;
    let userWallet: string | undefined;

    if (session?.user) {
      userId = session.user.id;
      userEmail = session.user.email || "";
    } else {
      // For MetaMask users, email should be provided or extracted from balance
      userEmail = body.email certo|| "";
      userWallet = body.walletAddress || "";
    }

    if (!userEmail) {
      return NextResponse.json(
        { error: "Email is required" },
        { status: 400 }
      );
    }

    // Get user balance
    const balance = await getUserBalance({
      userId,
      walletAddress: userWallet,
      email: userEmail,
    });

    if (!balance) {
      return NextResponse.json(
        { error: "Balance not found" },
        { status: 404 }
      );
    }

    const currentBalance = parseFloat(balance.balance);
    if (currentBalance < amount) {
      return NextResponse.json(
        { error: "Insufficient balance" },
        { status: 400 }
      );
    }

    // Create withdrawal record
    const withdrawal = await createWithdrawal({
      userId,
      walletAddress: userWallet,
      email: userEmail,
      amount,
      toWalletAddress,
    });

    // Update withdrawal status to processing
    await orgupdateWithdrawalStatus(withdrawal.id, "processing");

    try {
      // Debit balance
      const updatedBalance = await debitBalance({
        balanceId: balance.id,
        amount,
        description: `Withdrawal to ${toWalletAddress}`,
        relatedRequestId: withdrawal.id,
      });

      // Link withdrawal to balance transaction
      // Note: We need to get the last transaction ID
      // This is a simplified version - you might need to adjust

      // TODO: Send tokens to blockchain
      // For now, we'll mark as completed after balance is debited
      // In production, you should:
      // 1. Send tokens via wagmi/viem or server wallet
      // 2. Wait for transaction confirmation
      // 3. Update withdrawal with tx_hash
      // 4. Update status to completed

      // Placeholder: In real implementation, trigger blockchain transaction here
      // const txHash = await sendTokens(toWalletAddress, amount);

      // For now, mark as completed (manual processing or queue for admin)
      await updateWithdrawalStatus(withdrawal.id, "completed");

      return NextResponse.json({
        success: true,
        withdrawalId: withdrawal.id,
        message: "Withdrawal request created successfully",
        // In production, include tx_hash when available
      });
    } catch (error: any) {
      // Rollback withdrawal status
      await updateWithdrawalStatus(
        withdrawal.id,
        "failed",
        undefined,
        error.message
      );

      throw error;
    }
  } catch (error: any) {
    console.error("Error processing withdrawal:", error);
    return NextResponse.json(
      { error: error.message || "Failed to process withdrawal" },
      { status: 500 }
    );
  }
}

// GET /api/withdraw - Get withdrawal history
export async function GET(request: NextRequest) {
  try {
    const session = await getServerSession(authOptions);
    const searchParams = request.nextUrl.searchParams;

    const walletAddress = searchParams.get("walletAddress");
    const email = searchParams.get("email");

    let userId: string | undefined;
    let userEmail: string;
    let userWallet: string | undefined;

    if (session?.user) {
      userId = session.user.id;
      userEmail = session.user.email || email || "";
    } else if (walletAddress) {
      userWallet = walletAddress;
      userEmail = email || "";
    } else {
      return NextResponse.json(
        { error: "Authentication required" },
        { status: 401 }
      );
    }

    if (!userEmail) {
      return NextResponse.json(
        { error: "Email is required" },
        { status: 400 }
      );
    }

    const { getWithdrawalsByUser } = await import("@/lib/database/queries");
    const withdrawals = await getWithdrawalsByUser({
      userId,
      walletAddress: userWallet,
      email: userEmail,
    });

    return NextResponse.json({ withdrawals });
  } catch (error) {
    console.error("Error fetching withdrawals:", error);
    return NextResponse.json(
      { error: "Failed to fetch withdrawals" },
      { status: 500 }
    );
  }
}
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –î–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–æ–∫–µ–Ω–æ–≤ –Ω–∞ –±–ª–æ–∫—á–µ–π–Ω –Ω—É–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é. –≠—Ç–æ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:

1. **–í–∞—Ä–∏–∞–Ω—Ç A:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å wagmi –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ (—Ç—Ä–µ–±—É–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–π –∫–æ—à–µ–ª–µ–∫)
2. **–í–∞—Ä–∏–∞–Ω—Ç B:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–µ—Ä–≤–µ—Ä–Ω—ã–π –∫–æ—à–µ–ª–µ–∫ (—Ç—Ä–µ–±—É–µ—Ç –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)
3. **–í–∞—Ä–∏–∞–Ω—Ç C:** –û—á–µ—Ä–µ–¥—å –¥–ª—è —Ä—É—á–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º

### –ü—Ä–æ–≤–µ—Ä–∫–∞:

- [ ] API —Å–æ–∑–¥–∞–µ—Ç –≤—ã–≤–æ–¥
- [ ] –ë–∞–ª–∞–Ω—Å –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –∏ —Å–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è
- [ ] –ò—Å—Ç–æ—Ä–∏—è –≤—ã–≤–æ–¥–æ–≤ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è

---

## –°—Ç–∞–¥–∏—è 3.4: –ö–æ–º–ø–æ–Ω–µ–Ω—Ç —Ñ–æ—Ä–º—ã –≤—ã–≤–æ–¥–∞

**–í—Ä–µ–º—è:** 3-4 —á–∞—Å–∞

### –ó–∞–¥–∞—á–∏:

- [ ] –°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É/–∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –≤—ã–≤–æ–¥–∞ —Å—Ä–µ–¥—Å—Ç–≤
- [ ] –î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ä–º—É —Å –ø–æ–ª—è–º–∏: —Å—É–º–º–∞, –∞–¥—Ä–µ—Å –∫–æ—à–µ–ª—å–∫–∞
- [ ] –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é
- [ ] –ü–æ–∫–∞–∑–∞—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–π –±–∞–ª–∞–Ω—Å
- [ ] –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É –∑–∞–ø—Ä–æ—Å–∞

### –§–∞–π–ª—ã:

**–°–æ–∑–¥–∞—Ç—å:** `components/wallet/withdraw-form.tsx`

```typescript
"use client";

import { useState } from "react";
import { useAccount } from "wagmi";
import { Button } from "@/components/ui/button";
import { useInternalBalance } from "@/hooks/use-internal-balance";
import { useAuth } from "@/hooks/use-auth";
import { useTranslation } from "@/hooks/use-translation";
import toast from "react-hot-toast";

export function WithdrawForm() {
  const { address } = useAccount();
  const { userId, email } = useAuth();
  const { data: balanceData, refetch } = useInternalBalance();
  const t = useTranslation();

  const [amount, setAmount] = useState("");
  const [toAddress, setToAddress] = useState("");
  const [isSubmitting, setIsSubmitting] = useState(false);

  const availableBalance = balanceData?.balance || 0;

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();

    // Validation
    if (!amount || parseFloat(amount) <= 0) {
      toast.error(t("withdraw.validation.amountRequired"));
      return;
    }

    if (parseFloat(amount) > availableBalance) {
      toast.error(t("withdraw.validation.insufficientBalance"));
      return;
    }

    if (!toAddress || !/^0x[a-fA-F0-9]{40}$/.test(toAddress)) {
      toast.error(t("withdraw.validation.invalidAddress"));
      return;
    }

    setIsSubmitting(true);

    try {
      const response = await fetch("/api/withdraw", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          amount: parseFloat(amount),
          toWalletAddress: toAddress,
          walletAddress: address,
          email: email,
        }),
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || "Failed to process withdrawal");
      }

      toast.success(t("withdraw.success"));
      setAmount("");
      setToAddress("");
      refetch(); // Refresh balance
    } catch (error: any) {
      console.error("Withdrawal error:", error);
      toast.error(error.message || t("withdraw.error"));
    } finally {
      setIsSubmitting(false);
    }
  };

  return (
    <div className="space-y-4">
      <div className="rounded-lg border bg-card p-4">
        <div className="text-sm text-muted-foreground">
          {t("withdraw.availableBalance")}
        </div>
        <div className="text-2xl font-bold">
          {availableBalance.toFixed(8)} {balanceData?.currency || "TOKEN"}
        </div>
      </div>

      <form onSubmit={handleSubmit} className="space-y-4">
        <div>
          <label className="block text-sm font-medium mb-2">
            {t("withdraw.amount.label")}
          </label>
          <input
            type="number"
            step="0.00000001"
            min="0"
            max={availableBalance}
            value={amount}
            onChange={(e) => setAmount(e.target.value)}
            placeholder={t("withdraw.amount.placeholder")}
            className="w-full rounded-md border border-input bg-background px-3 py-2"
            required
          />
          <p className="text-xs text-muted-foreground mt-1">
            {t("withdraw.amount.hint")}
          </p>
        </div>

        <div>
          <label className="block text-sm font-medium mb-2">
            {t("withdraw.toAddress.label")}
          </label>
          <input
            type="text"
            value={toAddress}
            onChange={(e) => setToAddress(e.target.value)}
            placeholder={t("withdraw.toAddress.placeholder")}
            className="w-full rounded-md border border-input bg-background px-3 py-2 font-mono"
            required
          />
          <p className="text-xs text-muted-foreground mt-1">
            {t("withdraw.toAddress.hint")}
          </p>
        </div>

        <Button
          type="submit"
          disabled={isSubmitting || availableBalance <= 0}
          className="w-full"
        >
          {isSubmitting ? t("withdraw.processing") : t("withdraw.submit")}
        </Button>
      </form>
    </div>
  );
}
```

**–°–æ–∑–¥–∞—Ç—å:** `app/withdraw/page.tsx`

```typescript
import { WithdrawForm } from "@/components/wallet/withdraw-form";
import { WithdrawHistory } from "@/components/profile/withdraw-history";
import { PageTitle } from "@/components/layout/page-title";
import { useTranslation } from "@/hooks/use-translation";

export default function WithdrawPage() {
  const t = useTranslation();

  return (
    <>
      <PageTitle title={t("withdraw.pageTitle")} description={t("withdraw.pageDescription")} />
      <main className="container mx-auto px-4 py-8 max-w-4xl">
        <div className="space-y-8">
          <section>
            <h2 className="text-2xl font-bold mb-4">
              {t("withdraw.formTitle")}
            </h2>
            <WithdrawForm />
          </section>

          <section>
            <h2 className="text-2xl font-bold mb-4">
              {t("withdraw.historyTitle")}
            </h2>
            <WithdrawHistory />
          </section>
        </div>
      </main>
    </>
  );
}
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞:

- [ ] –§–æ—Ä–º–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] –í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –í—ã–≤–æ–¥ —Å–æ–∑–¥–∞–µ—Ç—Å—è —É—Å–ø–µ—à–Ω–æ
- [ ] –ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –≤—ã–≤–æ–¥–∞ –ø–æ–¥–∞—á–∞

---

## –°—Ç–∞–¥–∏—è 3.5: –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –∏—Å—Ç–æ—Ä–∏–∏ –≤—ã–≤–æ–¥–æ–≤

**–í—Ä–µ–º—è:** 2-3 —á–∞—Å–∞

### –ó–∞–¥–∞—á–∏:

Èáã - [ ] –°–æ–∑–¥–∞—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –≤—ã–≤–æ–¥–æ–≤

- [ ] –ü–æ–ª—É—á–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ API
- [ ] –û—Ç–æ–±—Ä–∞–∂–∞—Ç—å —Å—Ç–∞—Ç—É—Å—ã –∏ —Å—É–º–º—ã
- [ ] –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ –ø—Ä–æ—Ñ–∏–ª—å

### –§–∞–π–ª—ã:

**–°–æ–∑–¥–∞—Ç—å:** `components/profile/withdraw-history.tsx`

```typescript
"use client";

import { useQuery } from "@tanstack/react-query";
import { useAccount } from "wagmi";
import { useAuth } from "@/hooks/use-auth";
import { useTranslation } from "@/hooks/use-translation";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";

export function WithdrawHistory() {
  const { address } = useAccount();
  const { userId, email } = useAuth();
  const t = useTranslation();

  const { data, isLoading } = useQuery({
    queryKey: ["withdrawals", userId, address, email],
    queryFn: async () => {
      const params = new URLSearchParams();

      if (userId && email) {
        params.append("email", email);
      } else if (address) {
        params.append("walletAddress", address);
        if (email) {
          params.append("email", email);
        }
      }

      const response = await fetch(`/api/withdraw?${params.toString()}`);

      if (!response.ok) {
        throw new Error("Failed to fetch withdrawals");
      }

      return await response.json();
    },
    enabled: !!(userId || address) && !!email,
  });

  const withdrawals = data?.withdrawals || [];

  if (isLoading) {
    return (
      <Card>
        <CardHeader>
          <CardTitle>{t("withdraw.historyTitle")}</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="space-y-2">
            {[1, 2, 3].map((i) => (
              <div key={i} className="h-16 animate-pulse rounded bg-muted" />
            ))}
          </div>
        </CardContent>
      </Card>
    );
  }

  if (withdrawals.length === 0) {
    return (
      <Card>
        <CardHeader>
          <CardTitle>{t("withdraw.historyTitle")}</CardTitle>
        </CardHeader>
        <CardContent>
          <p className="text-muted-foreground">
            {t("withdraw.noWithdrawals")}
          </p>
        </CardContent>
      </Card>
    );
  }

  const getStatusColor = (status: string) => {
    switch (status) {
      case "completed":
        return "text-green-600";
      case "processing":
        return "text-yellow-600";
      case "failed":
        return "text-red-600";
      default:
        return "text-gray-600";
    }
  };

  return (
    <Card>
      <CardHeader>
        <CardTitle>{t("withdraw.historyTitle")}</CardTitle>
      </CardHeader>
      <CardContent>
        <div className="space-y-4">
          {withdrawals.map((withdrawal: any) => (
            <div
              key={withdrawal.id}
              className="flex items-center justify-between border-b pb-4"
            >
              <div className="space-y-1">
                <div className="font-medium">
                  {parseFloat(withdrawal.amount).toFixed(8)} {withdrawal.currency}
                </div>
                <div className="text-sm text-muted-foreground font-mono">
                  {withdrawal.to_wallet_address.slice(0, 10)}...
                  {withdrawal.to_wallet_address.slice(-8)}
                </div>
                <div className="text-xs text-muted-foreground">
                  {new Date(withdrawal.created_at).toLocaleString()}
                </div>
              </div>
              <div className="text-right">
                <div className={`font-medium ${getStatusColor(withdrawal.status)}`}>
                  {t(`withdraw.status.${withdrawal.status}`)}
                </div>
                {withdrawal.tx_hash && (
                  <div className="text-xs text-muted-foreground font-mono">
                    {withdrawal.tx_hash.slice(0, 10)}...
                  </div>
                )}
              </div>
            </div>
          ))}
        </div>
      </CardContent>
    </Card>
  );
}
```

**–ò–∑–º–µ–Ω–∏—Ç—å:** `app/profile/page.tsx` (–¥–æ–±–∞–≤–∏—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

### –ü—Ä–æ–≤–µ—Ä–∫–∞:

- [ ] –ò—Å—Ç–æ—Ä–∏—è –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] –°—Ç–∞—Ç—É—Å—ã –∏–º–µ—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ü–≤–µ—Ç–∞
- [ ] –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è

---

## –°—Ç–∞–¥–∏—è 3.6: –í–∏–∑—É–∞–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ —Å–æ —Å—Ç–æ–∏–º–æ—Å—Ç—å—é

**–í—Ä–µ–º—è:** 1-2 —á–∞—Å–∞

### –ó–∞–¥–∞—á–∏:

- [ ] –î–æ–±–∞–≤–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–∞ –≤ USD –¥–ª—è —Ç–æ–∫–µ–Ω–æ–≤ –≤—ã–≤–æ–¥–∞
- [ ] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–ª–∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –∫—É—Ä—Å
- [vote ] –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –¥–ª—è –ø–æ–∫–∞–∑–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏

### –§–∞–π–ª—ã:

**–°–æ–∑–¥–∞—Ç—å:** `lib/pricing.ts` (–¥–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫—É—Ä—Å–∞)

```typescript
// Add to existing pricing.ts or create if doesn't exist

// For refund tokens, use a fixed display rate
// This doesn't reflect real market value, just for UI display
export const REFUND_TOKEN_DISPLAY_RATE = parseFloat(
  process.env.NEXT_PUBLIC_REFUND_TOKEN_DISPLAY_RATE || "1.0",
); // Default: 1 USD per token

export function getRefundTokenUsdValue(tokenAmount: number): number {
  return tokenAmount * REFUND_TOKEN_DISPLAY_RATE;
}

export function formatRefundTokenUsdValue(tokenAmount: number): string {
  const usdValue = getRefundTokenUsdValue(tokenAmount);
  return `‚âà $${usdValue.toFixed(2)}`;
}
```

**–ò–∑–º–µ–Ω–∏—Ç—å:** `components/wallet/internal-balance-card.tsx` (–¥–æ–±–∞–≤–∏—Ç—å USD –∑–Ω–∞—á–µ–Ω–∏–µ)

```typescript
import { formatRefundTokenUsdValue } from "@/lib/pricing";

// –í –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å:
<div className="space-y-2">
  <div className="text-3xl font-bold">
    {data?.formattedBalance || "0.00000000"} {data?.currency || "TOKEN"}
  </div>
  <div className="text-lg text-muted-foreground">
    {formatRefundTokenUsdValue(parseFloat(data?.balance || "0"))}
  </div>
  <p className="text-sm text-muted-foreground">
    {t("wallet.internalBalance.hint")}
    <span className="block text-xs mt-1">
      {t("wallet.internalBalance.displayRate")}
    </span>
  </p>
</div>
```

**–ò–∑–º–µ–Ω–∏—Ç—å:** `components/wallet/withdraw-form.tsx` (–ø–æ–∫–∞–∑–∞—Ç—å USD –ø—Ä–∏ –≤–≤–æ–¥–µ —Å—É–º–º—ã)

```typescript
import { formatRefundTokenUsdValue } from "@/lib/pricing";

// –í —Ñ–æ—Ä–º–µ –¥–æ–±–∞–≤–∏—Ç—å:
{amount && parseFloat(amount) > 0 && (
  <div className="text-sm text-muted-foreground">
    ‚âà {formatRefundTokenUsdValue(parseFloat(amount))}
  </div>
)}
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞:

- [ ] USD –∑–Ω–∞—á–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è
- [ ] –ö—É—Ä—Å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è
- [ ] –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–Ω—è—Ç–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

---

## –ò—Ç–æ–≥–∏ –≠—Ç–∞–ø–∞ 3

**–ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**

- ‚úÖ –¢–∞–±–ª–∏—Ü–∞ –∏—Å—Ç–æ—Ä–∏–∏ –≤—ã–≤–æ–¥–æ–≤
- ‚úÖ API –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏ –ø–æ–ª—É—á–µ–Ω–∏—è –≤—ã–≤–æ–¥–æ–≤
- ‚úÖ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç —Ñ–æ—Ä–º—ã –≤—ã–≤–æ–¥–∞
- ‚úÖ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –∏—Å—Ç–æ—Ä–∏–∏ –≤—ã–≤–æ–¥–æ–≤
- ‚úÖ –°–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –ø—Ä–∏ –≤—ã–≤–æ–¥–µ
- ‚úÖ –í–∏–∑—É–∞–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ —Å–æ —Å—Ç–æ–∏–º–æ—Å—Ç—å—é

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤ –Ω–∞ –±–ª–æ–∫—á–µ–π–Ω —Ç—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ (—Å–µ—Ä–≤–µ—Ä–Ω—ã–π –∫–æ—à–µ–ª–µ–∫ –∏–ª–∏ –∫–ª–∏–µ–Ω—Ç—Å–∫–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å wagmi).

**–°–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø:** –û–ø–ª–∞—Ç–∞ –∑–∞ —É—Å–ª—É–≥–∏

---

# –≠—Ç–∞–ø 4: –û–ø–ª–∞—Ç–∞ –∑–∞ —É—Å–ª—É–≥–∏

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –°—Ä–µ–¥–Ω–∏–π  
**–í—Ä–µ–º—è:** 2 —á–∞—Å–∞ (–≤–∞—Ä–∏–∞–Ω—Ç A)  
**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** –ù–µ—Ç

---

## –°—Ç–∞–¥–∏—è 4.1: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –æ–± –æ–ø–ª–∞—Ç–µ

**–í—Ä–µ–º—è:** 2 —á–∞—Å–∞

### –ó–∞–¥–∞—á–∏:

- [ ] –°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–ª–∏ —Ä–∞–∑–¥–µ–ª "–û–ø–ª–∞—Ç–∞ —É—Å–ª—É–≥"
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–Ω—Ç–∞–∫—Ç–∞—Ö –ø–æ–¥–¥–µ—Ä–∂–∫–∏
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ–±–º–µ–Ω–Ω–∏–∫–µ
- [ ] –î–æ–±–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫–∏ –Ω–∞ Telegram –±–æ—Ç–∞

### –§–∞–π–ª—ã:

**–°–æ–∑–¥–∞—Ç—å:** `app/payment/page.tsx`

```typescript
import { PageTitle } from "@/components/layout/page-title";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { useTranslation } from "@/hooks/use-translation";
import Link from "next/link";

export default function PaymentPage() {
  const t = useTranslation();

  return (
    <>
      <PageTitle
        title={t("payment.pageTitle")}
        description={t("payment.pageDescription")}
      />
      <main className="container mx-auto px-4 py-8 max-w-4xl">
        <div className="space-y-6">
          <Card>
            <CardHeader>
              <CardTitle>{t("payment.support.title")}</CardTitle>
              <CardDescription>
                {t("payment.support.description")}
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
              <div>
                <h3 className="font-semibold mb-2">
                  {t("payment.support.contactSupport")}
                </h3>
                <p className="text-muted-foreground">
                  {t("payment.support.instructions")}
                </p>
                <div className="mt-4 space-y-2">
                  <div>
                    <strong>Email:</strong>{" "}
                    <a
                      href={`mailto:${process.env.NEXT_PUBLIC_SUPPORT_EMAIL || "support@company.io"}`}
                      className="text-primary hover:underline"
                    >
                      {process.env.NEXT_PUBLIC_SUPPORT_EMAIL || "support@company.io"}
                    </a>
                  </div>
                  <div>
                    <strong>Telegram:</strong>{" "}
                    <a
                      href={process.env.NEXT_PUBLIC_TELEGRAM_BOT_LINK || "#"}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="text-primary hover:underline"
                    >
                      {t("payment.support.telegramLink")}
                    </a>
                  </div>
                </div>
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardHeader>
              <CardTitle>{t("payment.exchange.title")}</CardTitle>
              <CardDescription>
                {t("payment.exchange.description")}
              </CardDescription>
            </CardHeader>
            <CardContent>
              <p className="text-muted-foreground mb-4">
                {t("payment.exchange.instructions")}
              </p>
              <Link
                href="/exchange"
                className="inline-block"
              >
                <Button>
                  {t("payment.exchange.goToExchange")}
                </Button>
              </Link>
            </CardContent>
          </Card>

          <Card>
            <CardHeader>
              <CardTitle>{t("payment.services.title")}</CardTitle>
            </CardHeader>
            <CardContentÁöÑÊúçÂä°>
              <ul className="list-disc list-inside space-y-2 text-muted-foreground">
                <li>{t("payment.services.item1")}</li>
                <li>{t("payment.services.item2")}</li>
                <li>{t("payment.services.item3")}</li>
              </ul>
            </CardContent>
          </Card>
        </div>
      </main>
    </>
  );
}
```

**–ò–∑–º–µ–Ω–∏—Ç—å:** `components/layout/navigation.tsx` (–¥–æ–±–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É –≤ –º–µ–Ω—é)

```typescript
// Add to navigation menu:
<Link href="/payment">
  {tÂ§¥Âèë("nav.payment")}
</Link>
```

**–ò–∑–º–µ–Ω–∏—Ç—å:** `lib/i18n/translations.ts` (–¥–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–≤–æ–¥—ã)

```typescript
// Add translations for payment page
payment: {
  pageTitle: "–û–ø–ª–∞—Ç–∞ —É—Å–ª—É–≥",
  pageDescription: "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ–ø–ª–∞—Ç–µ —É—Å–ª—É–≥ –∏ –∫–æ–º–∏—Å—Å–∏–π",
  support: {
    title: "–°–≤—è–∑—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π",
    description: "–î–ª—è –æ–ø–ª–∞—Ç—ã —É—Å–ª—É–≥ –∏ –∫–æ–º–∏—Å—Å–∏–π —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞—à–∏–º –æ—Ç–¥–µ–ª–æ–º –ø–æ–¥–¥–µ—Ä–∂–∫–∏",
    contactSupport: "–°–≤—è–∑–∞—Ç—å—Å—è —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π",
    instructions: "–í—ã –º–æ–∂–µ—Ç–µ —Å–≤—è–∑–∞—Ç—å—Å—è —Å –Ω–∞–º–∏ –ø–æ email –∏–ª–∏ —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞",
    telegramLink: "–ü–µ—Ä–µ–π—Ç–∏ –≤ Telegram –±–æ—Ç",
  },
  exchange: {
    title: "–ß–µ—Ä–µ–∑ –æ–±–º–µ–Ω–Ω–∏–∫",
    description: "–û–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ –Ω–∞—à –æ–±–º–µ–Ω–Ω–∏–∫",
    instructions: "–í—ã –º–æ–∂–µ—Ç–µ –æ–ø–ª–∞—Ç–∏—Ç—å —É—Å–ª—É–≥–∏ —á–µ—Ä–µ–∑ –Ω–∞—à –æ–±–º–µ–Ω–Ω–∏–∫ —Ç–æ–∫–µ–Ω–æ–≤",
    goToExchange: "–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–±–º–µ–Ω–Ω–∏–∫—É",
  },
  services: {
    title: "–ß—Ç–æ –º–æ–∂–Ω–æ –æ–ø–ª–∞—Ç–∏—Ç—å",
    item1: "–ö–æ–º–∏—Å—Å–∏–∏ –∑–∞ –≤—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤",
    item2: "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏",
    item3: "–ü—Ä–µ–º–∏—É–º —Ñ—É–Ω–∫—Ü–∏–∏",
  },
},
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞:

- [ ] –°—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] –ö–æ–Ω—Ç–∞–∫—Ç—ã –∞–∫—Ç—É–∞–ª—å–Ω—ã
- [ ] –°—Å—ã–ª–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç
- [ ] –ü–µ—Ä–µ–≤–æ–¥—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã

---

## –ò—Ç–æ–≥–∏ –≠—Ç–∞–ø–∞ 4

**–ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**

- ‚úÖ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –æ–± –æ–ø–ª–∞—Ç–µ —É—Å–ª—É–≥
- ‚úÖ –ö–æ–Ω—Ç–∞–∫—Ç—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∏ –æ–±–º–µ–Ω–Ω–∏–∫–∞
- ‚úÖ –°—Å—ã–ª–∫–∏ –Ω–∞ Telegram –±–æ—Ç–∞ –∏ –æ–±–º–µ–Ω–Ω–∏–∫

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã:**

- **–í–∞—Ä–∏–∞–Ω—Ç B:** –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ Telegram –±–æ—Ç–∞ –¥–ª—è –æ–ø–ª–∞—Ç—ã (5-8 —á–∞—Å–æ–≤)
- **–í–∞—Ä–∏–∞–Ω—Ç C:** –ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö —Å–∏—Å—Ç–µ–º –Ω–∞ —Å–∞–π—Ç–µ (2-3 –Ω–µ–¥–µ–ª–∏)

---

## üìä –û–±—â–∏–π –∏—Ç–æ–≥ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –ß—Ç–æ –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:

1. ‚úÖ **–ó–∞—è–≤–ª–µ–Ω–∏–µ –Ω–∞ –≤–æ–∑–≤—Ä–∞—Ç** ‚Äî –ø–æ–ª–Ω–∞—è —Ñ–æ—Ä–º–∞ —Å –§–ò–û, —Å—É–º–º–æ–π, –∑–∞–≥—Ä—É–∑–∫–æ–π —á–µ–∫–æ–≤
2. ‚úÖ **–°–∏—Å—Ç–µ–º–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞** ‚Äî –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ, –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –∏—Å—Ç–æ—Ä–∏—è
3. ‚úÖ **–í—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤** ‚Äî —Ñ–æ—Ä–º–∞, API, –∏—Å—Ç–æ—Ä–∏—è, –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ —Å—Ç–æ–∏–º–æ—Å—Ç—å—é
4. ‚úÖ **–û–ø–ª–∞—Ç–∞ –∑–∞ —É—Å–ª—É–≥–∏** ‚Äî –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ (–∏–ª–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç)

### –û–±—â–µ–µ –≤—Ä–µ–º—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏: ~25-35 —á–∞—Å–æ–≤

### –ü–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:

1. **–ù–µ–¥–µ–ª—è 1:** –≠—Ç–∞–ø 1 (—Ñ–æ—Ä–º–∞) + –≠—Ç–∞–ø 2 (–±–∞–ª–∞–Ω—Å) ‚Äî 12-18 —á–∞—Å–æ–≤
2. **–ù–µ–¥–µ–ª—è 2:** –≠—Ç–∞–ø 3 (–≤—ã–≤–æ–¥) ‚Äî 12-16 —á–∞—Å–æ–≤
3. **–ù–µ–¥–µ–ª—è 2-3:** –≠—Ç–∞–ø 4 (–æ–ø–ª–∞—Ç–∞) ‚Äî 2 —á–∞—Å–∞

### –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è Ïó∞:

1. **–û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤ –Ω–∞ –±–ª–æ–∫—á–µ–π–Ω** —Ç—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ (–°—Ç–∞–¥–∏—è 3.3)
2. **–•—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤** –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å –æ–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ (S3, Cloudinary) –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
3. **–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è** –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ `.env`:
   - `NEXT_PUBLIC_REFUND_TOKEN_DISPLAY_RATE` ‚Äî –∫—É—Ä—Å –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
   - `NEXT_PUBLIC_SUPPORT_EMAIL` ‚Äî email –ø–æ–¥–¥–µ—Ä–∂–∫–∏
   - `NEXT_PUBLIC_TELEGRAM_BOT_LINK` ‚Äî —Å—Å—ã–ª–∫–∞ –Ω–∞ –±–æ—Ç–∞
4. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** –∫–∞–∂–¥–æ–π —Å—Ç–∞–¥–∏–∏ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ö–æ–¥–æ–º –∫ —Å–ª–µ–¥—É—é—â–µ–π

---

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. –£—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
2. –†–µ—à–∏—Ç—å –≤–æ–ø—Ä–æ—Å—ã –ø–æ –æ—Ç–∫—Ä—ã—Ç—ã–º –º–æ–º–µ–Ω—Ç–∞–º (—Ç–æ–∫–µ–Ω—ã, —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤, –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ –±–ª–æ–∫—á–µ–π–Ω)
3. –ù–∞—á–∞—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é —Å –≠—Ç–∞–ø–∞ 1
4. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —ç—Ç–∞–ø–∞

---

**–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** 2025-01-27  
**–°—Ç–∞—Ç—É—Å:** –ì–æ—Ç–æ–≤ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏






