# üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞

## –î–∞—Ç–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: $(date)

## ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. **–°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –∏ –¥–æ—Å—Ç—É–ø–µ–Ω**
   - ‚úÖ API —ç–Ω–¥–ø–æ–∏–Ω—Ç `/api/internal-balance/credit` –æ—Ç–≤–µ—á–∞–µ—Ç
   - ‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç (–ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞ –ø—Ä–æ—Ö–æ–¥–∏—Ç)

2. **–í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö**
   - ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ –∞–¥—Ä–µ—Å–∞ –∫–æ—à–µ–ª—å–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
   - ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—É–º–º—ã —Ä–∞–±–æ—Ç–∞–µ—Ç
   - ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç

3. **–°–∫—Ä–∏–ø—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è**
   - ‚úÖ `npm run test:balance-credit` - –±–∞–∑–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –≥–æ—Ç–æ–≤
   - ‚úÖ `npm run test:balance-credit-full` - –ø–æ–ª–Ω—ã–π —Å–∫—Ä–∏–ø—Ç —Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–µ–π –≥–æ—Ç–æ–≤

## ‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### –ü—Ä–æ–±–ª–µ–º–∞ 1: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

**–û—à–∏–±–∫–∞:**
```
Failed query: select "id", "name", "email", ... from "users" 
where "users"."wallet_address" = $1 limit $2
```

**–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:**
1. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞
2. –¢–∞–±–ª–∏—Ü–∞ `users` –Ω–µ —Å–æ–∑–¥–∞–Ω–∞
3. –ú–∏–≥—Ä–∞—Ü–∏–∏ –Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã
4. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π `DATABASE_URL` –≤ `.env.local`

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö:
   ```bash
   # –ü—Ä–æ–≤–µ—Ä—å—Ç–µ DATABASE_URL –≤ .env.local
   grep DATABASE_URL .env.local
   ```

2. –ü—Ä–∏–º–µ–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏:
   ```bash
   npm run db:init
   npm run db:migrate
   ```

3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü:
   ```sql
   SELECT table_name 
   FROM information_schema.tables 
   WHERE table_schema = 'public' 
   AND table_name = 'users';
   ```

### –ü—Ä–æ–±–ª–µ–º–∞ 2: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω

**–û—à–∏–±–∫–∞:** `Wallet address is not registered`

**–†–µ—à–µ–Ω–∏–µ:**
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –ø–µ—Ä–µ–¥ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ–º –±–∞–ª–∞–Ω—Å–∞. –ï—Å—Ç—å –¥–≤–∞ —Å–ø–æ—Å–æ–±–∞:

1. **–ß–µ—Ä–µ–∑ —Å–∞–π—Ç:**
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥–∫–ª—é—á–∞–µ—Ç –∫–æ—à–µ–ª–µ–∫ –Ω–∞ —Å–∞–π—Ç–µ
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `/api/user/register-wallet`

2. **–ß–µ—Ä–µ–∑ API:**
   ```bash
   curl -X POST http://localhost:3000/api/user/register-wallet \
     -H "Content-Type: application/json" \
     -d '{
       "walletAddress": "0x...",
       "name": "User Name"
     }'
   ```

## üìã –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è —É—Å–ø–µ—à–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
npm run db:test

# –ü—Ä–∏–º–µ–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
npm run db:init
npm run db:migrate
```

### –®–∞–≥ 2: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–í–∞—Ä–∏–∞–Ω—Ç A: –ß–µ—Ä–µ–∑ —Å–∞–π—Ç**
1. –û—Ç–∫—Ä–æ–π—Ç–µ —Å–∞–π—Ç –≤ –±—Ä–∞—É–∑–µ—Ä–µ
2. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ MetaMask –∫–æ—à–µ–ª–µ–∫
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è

**–í–∞—Ä–∏–∞–Ω—Ç B: –ß–µ—Ä–µ–∑ API**
```bash
curl -X POST http://localhost:3000/api/user/register-wallet \
  -H "Content-Type: application/json" \
  -d '{
    "walletAddress": "–í–ê–®_–ê–î–†–ï–°_–ö–û–®–ï–õ–¨–ö–ê",
    "name": "Test User"
  }'
```

### –®–∞–≥ 3: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞

–ü–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:

```bash
# –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∞–¥—Ä–µ—Å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
npm run test:balance-credit –í–ê–®_–ê–î–†–ï–°_–ö–û–®–ï–õ–¨–ö–ê 100 "Test credit"
```

–ò–ª–∏ —á–µ—Ä–µ–∑ curl:
```bash
SECRET=$(grep INTERNAL_BALANCE_SIGNING_SECRET .env.local | cut -d '=' -f2)
curl -X POST http://localhost:3000/api/internal-balance/credit \
  -H "Content-Type: application/json" \
  -H "x-internal-admin-token: $SECRET" \
  -d '{
    "walletAddress": "–í–ê–®_–ê–î–†–ï–°_–ö–û–®–ï–õ–¨–ö–ê",
    "amount": "100",
    "reference": "Test credit",
    "createdBy": "admin"
  }'
```

## ‚úÖ –£—Å–ø–µ—à–Ω—ã–π —Ç–µ—Å—Ç –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑–∞—Ç—å

```json
{
  "tokenSymbol": "EURC",
  "decimals": 18,
  "wallet": {
    "id": "...",
    "walletAddress": "0x...",
    "userId": "..."
  },
  "balance": {
    "balance": "100000000000000000000",
    "tokenSymbol": "EURC"
  },
  "ledger": [...],
  "lastEntry": {
    "id": "...",
    "entryType": "credit",
    "amount": "100000000000000000000",
    "balanceAfter": "100000000000000000000",
    "reference": "Test credit",
    "createdBy": "admin",
    "createdAt": "..."
  }
}
```

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º

### –ï—Å–ª–∏ –ø–æ–ª—É—á–∞–µ—Ç–µ –æ—à–∏–±–∫—É –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î:

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `DATABASE_URL` –≤ `.env.local`
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ PostgreSQL –∑–∞–ø—É—â–µ–Ω
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

### –ï—Å–ª–∏ –ø–æ–ª—É—á–∞–µ—Ç–µ "Wallet address is not registered":

1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ —Å–∞–π—Ç –∏–ª–∏ API
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∞–¥—Ä–µ—Å –∫–æ—à–µ–ª—å–∫–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π (42 —Å–∏–º–≤–æ–ª–∞)
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω –≤ —Ç–∞–±–ª–∏—Ü–µ `users`

### –ï—Å–ª–∏ –ø–æ–ª—É—á–∞–µ—Ç–µ "Invalid admin token":

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `INTERNAL_BALANCE_SIGNING_SECRET` –≤ `.env.local`
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ
3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö

## üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
2. ‚úÖ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
3. ‚úÖ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å —Ç–µ—Å—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞
4. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –Ω–∞ —Å–∞–π—Ç–µ
5. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏ –Ω–∞ –≤—ã–≤–æ–¥

## üìö –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

```bash
# –¢–µ—Å—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞
npm run test:balance-credit <wallet> <amount> [reference]

# –ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç —Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–µ–π (–µ—Å–ª–∏ –ë–î —Ä–∞–±–æ—Ç–∞–µ—Ç)
npm run test:balance-credit-full <wallet> <amount> [reference]

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞ —á–µ—Ä–µ–∑ API
curl "http://localhost:3000/api/internal-balance?walletAddress=<wallet>"

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–ø–ª–∞—Ç
npm run treasury:process
```

