# üß™ –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –°–ø–æ—Å–æ–± 1: –ß–µ—Ä–µ–∑ —Å–∫—Ä–∏–ø—Ç (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```bash
# –ë–∞–∑–æ–≤–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ
npm run test:balance-credit 0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb 100

# –° –æ–ø–∏—Å–∞–Ω–∏–µ–º
npm run test:balance-credit 0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb 50 "Test credit"
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**

- `walletAddress` - –∞–¥—Ä–µ—Å –∫–æ—à–µ–ª—å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
- `amount` - —Å—É–º–º–∞ –¥–ª—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
- `reference` - –æ–ø–∏—Å–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### –°–ø–æ—Å–æ–± 2: –ß–µ—Ä–µ–∑ curl

```bash
curl -X POST http://localhost:3000/api/internal-balance/credit \
  -H "Content-Type: application/json" \
  -H "x-internal-admin-token: $(grep INTERNAL_BALANCE_SIGNING_SECRET .env.local | cut -d '=' -f2)" \
  -d '{
    "walletAddress": "0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb",
    "amount": "100",
    "reference": "Test credit",
    "createdBy": "admin"
  }'
```

### –°–ø–æ—Å–æ–± 3: –ß–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞

1. –û—Ç–∫—Ä–æ–π—Ç–µ Telegram –±–æ—Ç–∞
2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É `/credit`
3. –°–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º:
   - –í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –∫–æ—à–µ–ª—å–∫–∞
   - –í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É
   - –í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ (–∏–ª–∏ "-" –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–∞)
   - –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ

---

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º

### 1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω

```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç
curl http://localhost:3000/api/internal-balance
```

### 2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ —Å–µ–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞
grep INTERNAL_BALANCE_SIGNING_SECRET .env.local
```

### 3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –≤ —Å–∏—Å—Ç–µ–º–µ. –ï—Å–ª–∏ –Ω–µ—Ç:

- –ü–æ–ø—Ä–æ—Å–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å –∫–æ—à–µ–ª–µ–∫ –Ω–∞ —Å–∞–π—Ç–µ
- –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `userId` –≤–º–µ—Å—Ç–æ `walletAddress`

---

## –ü—Ä–∏–º–µ—Ä—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –ü—Ä–∏–º–µ—Ä 1: –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ 100 —Ç–æ–∫–µ–Ω–æ–≤

```bash
npm run test:balance-credit 0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb 100
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**

```
üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞...

üìç URL: http://localhost:3000/api/internal-balance/credit
üíº –ö–æ—à–µ–ª–µ–∫: 0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb
üí∞ –°—É–º–º–∞: 100
üìù –û–ø–∏—Å–∞–Ω–∏–µ: ‚Äî

‚úÖ –ë–∞–ª–∞–Ω—Å —É—Å–ø–µ—à–Ω–æ –Ω–∞—á–∏—Å–ª–µ–Ω!

üìä –†–µ–∑—É–ª—å—Ç–∞—Ç:
   –ö–æ—à–µ–ª–µ–∫: 0x742d35cc6634c0532925a3b844bc9e7595f0beb
   –¢–æ–∫–µ–Ω: EURC
   –ù–∞—á–∏—Å–ª–µ–Ω–æ: 100 EURC
   –ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: 100.00 EURC
   ID –æ–ø–µ—Ä–∞—Ü–∏–∏: <uuid>
   –¢–∏–ø: credit
   –î–∞—Ç–∞: <timestamp>

‚úÖ –¢–µ—Å—Ç –ø—Ä–æ–π–¥–µ–Ω —É—Å–ø–µ—à–Ω–æ!
```

### –ü—Ä–∏–º–µ—Ä 2: –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º

```bash
npm run test:balance-credit 0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb 50 "Refund for request #123"
```

### –ü—Ä–∏–º–µ—Ä 3: –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –¥—Ä–æ–±–Ω–æ–π —Å—É–º–º—ã

```bash
npm run test:balance-credit 0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb 100.5
```

---

## –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ API

```bash
curl "http://localhost:3000/api/internal-balance?walletAddress=0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb"
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–∞–π—Ç–µ

1. –û—Ç–∫—Ä–æ–π—Ç–µ —Å–∞–π—Ç
2. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª–µ–∫ –∏–ª–∏ –≤–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ email
3. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å –±–∞–ª–∞–Ω—Å–æ–º
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
SELECT
  iw.wallet_address,
  ib.balance,
  ib.token_symbol
FROM internal_balances ib
JOIN internal_wallets iw ON ib.wallet_id = iw.id
WHERE iw.wallet_address = '0x742d35cc6634c0532925a3b844bc9e7595f0beb';

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –æ–ø–µ—Ä–∞—Ü–∏–π
SELECT
  entry_type,
  amount,
  balance_after,
  reference,
  created_by,
  created_at
FROM internal_ledger
WHERE wallet_id = (
  SELECT id FROM internal_wallets
  WHERE wallet_address = '0x742d35cc6634c0532925a3b844bc9e7595f0beb'
)
ORDER BY created_at DESC
LIMIT 10;
```

---

## –í–æ–∑–º–æ–∂–Ω—ã–µ –æ—à–∏–±–∫–∏ –∏ —Ä–µ—à–µ–Ω–∏—è

### –û—à–∏–±–∫–∞: "INTERNAL_BALANCE_SIGNING_SECRET –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"

**–†–µ—à–µ–Ω–∏–µ:**

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∞–π–ª `.env.local`
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä

### –û—à–∏–±–∫–∞: "Wallet address is not registered"

**–†–µ—à–µ–Ω–∏–µ:**

1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω
2. –ü–æ–ø—Ä–æ—Å–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å –∫–æ—à–µ–ª–µ–∫ –Ω–∞ —Å–∞–π—Ç–µ
3. –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `userId` –≤–º–µ—Å—Ç–æ `walletAddress`

### –û—à–∏–±–∫–∞: "Invalid admin token"

**–†–µ—à–µ–Ω–∏–µ:**

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ `INTERNAL_BALANCE_SIGNING_SECRET` –≤ `.env.local` —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ç–µ–º, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∑–∞–ø—Ä–æ—Å–µ
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫ `x-internal-admin-token` —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–µ–∫—Ä–µ—Ç

### –û—à–∏–±–∫–∞: "Invalid wallet address"

**–†–µ—à–µ–Ω–∏–µ:**

1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∞–¥—Ä–µ—Å –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å `0x`
2. –ê–¥—Ä–µ—Å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ä–æ–≤–Ω–æ 42 —Å–∏–º–≤–æ–ª–∞
3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç Ethereum –∞–¥—Ä–µ—Å–∞

---

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è internal_wallet

–ü–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç—Å—è `internal_wallet`:

```sql
SELECT * FROM internal_wallets
WHERE wallet_address = '0x742d35cc6634c0532925a3b844bc9e7595f0beb';
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø–∏—Å–∏ –≤ ledger

–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ `internal_ledger`:

```sql
SELECT * FROM internal_ledger
WHERE wallet_id = (
  SELECT id FROM internal_wallets
  WHERE wallet_address = '0x742d35cc6634c0532925a3b844bc9e7595f0beb'
)
ORDER BY created_at DESC;
```

---

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

1. ‚úÖ –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –Ω–∞ —Å–∞–π—Ç–µ
3. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏ –Ω–∞ –≤—ã–≤–æ–¥
4. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –æ–¥–æ–±—Ä–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏
5. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –æ–±—Ä–∞–±–æ—Ç–∫—É –≤—ã–ø–ª–∞—Ç—ã

---

## –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

```bash
# –¢–µ—Å—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞
npm run test:balance-credit <wallet> <amount> [reference]

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞ —á–µ—Ä–µ–∑ API
curl "http://localhost:3000/api/internal-balance?walletAddress=<wallet>"

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–ø–ª–∞—Ç
npm run treasury:process
```
