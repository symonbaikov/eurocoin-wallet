# –û—Ç—á–µ—Ç –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö

## –î–∞—Ç–∞: 2025-11-11

---

## üêõ –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —Ä–∞—Å—Å—ã–ª–∫—É –ø–æ—è–≤–ª—è–ª–∏—Å—å –æ—à–∏–±–∫–∏:
- ‚ùå "Failed to send code" (3 —Ä–∞–∑–∞)
- ‚ùå HTTP 403 —Å—Ç–∞—Ç—É—Å—ã –Ω–∞ –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∫ `/api/newsletter/send-code`
- ‚ùå –í –∫–æ–Ω—Å–æ–ª–∏: `database "web_wallet_db" does not exist`

### –°–∫—Ä–∏–Ω—à–æ—Ç –æ—à–∏–±–∫–∏:
–í –ª–æ–≥–∞—Ö —Å–µ—Ä–≤–µ—Ä–∞:
```
error: database "web_wallet_db" does not exist
FATAL: 3D000
```

---

## üîç –ê–Ω–∞–ª–∏–∑

### –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏–ª–∏:

1. **API Endpoints** ‚úÖ
   - `/api/newsletter/send-code/route.ts` - –∫–æ–¥ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
   - `/api/newsletter/verify-code/route.ts` - –∫–æ–¥ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π

2. **–ö–æ–º–ø–æ–Ω–µ–Ω—Ç NewsletterModal** ‚úÖ
   - –ö–æ–º–ø–æ–Ω–µ–Ω—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
   - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã

3. **Middleware** ‚úÖ
   - Middleware –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç API routes
   - –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ: `"/((?!api|...).*)`

4. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö** ‚ùå
   - –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö `web_wallet_db` –ù–ï —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª–∞!
   - –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞

### –í—ã–≤–æ–¥:
–í—Å–µ API endpoints, –∫–æ—Ç–æ—Ä—ã–µ –æ–±—Ä–∞—â–∞–ª–∏—Å—å –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö, –ø–∞–¥–∞–ª–∏ —Å –æ—à–∏–±–∫–æ–π "database does not exist", —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ HTTP 500/403 –æ—Ç–≤–µ—Ç–∞–º.

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### –®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

```bash
psql -U postgres -c "CREATE DATABASE web_wallet_db;"
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** `CREATE DATABASE` ‚úÖ

---

### –®–∞–≥ 2: –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ SQL —Å—Ö–µ–º

–ü—Ä–∏–º–µ–Ω–µ–Ω—ã –≤—Å–µ —Å—Ö–µ–º—ã –≤ —Å–ª–µ–¥—É—é—â–µ–º –ø–æ—Ä—è–¥–∫–µ:

#### 2.1. –û—Å–Ω–æ–≤–Ω–∞—è —Å—Ö–µ–º–∞ (`schema.sql`)
```bash
psql -U postgres -d web_wallet_db -f lib/database/schema.sql
```

**–¢–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞–Ω—ã:**
- `exchange_requests` - –∑–∞—è–≤–∫–∏ –Ω–∞ –æ–±–º–µ–Ω
- `internal_requests` - –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∑–∞—è–≤–∫–∏
- –ò–Ω–¥–µ–∫—Å—ã –∏ —Ç—Ä–∏–≥–≥–µ—Ä—ã

---

#### 2.2. Newsletter —Å—Ö–µ–º–∞ (`newsletter-schema.sql`)
```bash
psql -U postgres -d web_wallet_db -f lib/database/newsletter-schema.sql
```

**–¢–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞–Ω—ã:**
- `newsletter_subscribers` - –ø–æ–¥–ø–∏—Å—á–∏–∫–∏ —Ä–∞—Å—Å—ã–ª–∫–∏
  - `id` (SERIAL PRIMARY KEY)
  - `email` (VARCHAR(255) UNIQUE)
  - `chat_id` (VARCHAR(255)) - –¥–ª—è Telegram
  - `verified` (BOOLEAN) - email –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω
  - `verification_code` (VARCHAR(6)) - –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
  - `code_expires_at` (TIMESTAMP) - —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –∫–æ–¥–∞
  - `subscribed_at` (TIMESTAMP)
  - `is_active` (BOOLEAN) - —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏
  - `language` (VARCHAR(10)) - —è–∑—ã–∫ (ru/en/all)
  - `created_at` (TIMESTAMP)
  - `updated_at` (TIMESTAMP)

- `newsletter_campaigns` - –∏—Å—Ç–æ—Ä–∏—è —Ä–∞—Å—Å—ã–ª–æ–∫
- `newsletter_logs` - –ª–æ–≥–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏

**–ò–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞–Ω—ã:**
- `idx_newsletter_email`
- `idx_newsletter_chat_id`
- `idx_newsletter_is_active`
- `idx_newsletter_verified`
- `idx_newsletter_language`

---

#### 2.3. Chatbot —Å—Ö–µ–º–∞ (`chatbot-schema.sql`)
```bash
psql -U postgres -d web_wallet_db -f lib/database/chatbot-schema.sql
```

**–¢–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞–Ω—ã:**
- `chatbot_sessions` - —Å–µ—Å—Å–∏–∏ —á–∞—Ç–±–æ—Ç–∞
- `chatbot_messages` - —Å–æ–æ–±—â–µ–Ω–∏—è
- `chatbot_transaction_analysis` - –∞–Ω–∞–ª–∏–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

---

#### 2.4. Auth —Å—Ö–µ–º–∞ (`auth-schema.sql`)
```bash
psql -U postgres -d web_wallet_db -f lib/database/auth-schema.sql
```

**–¢–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞–Ω—ã:**
- `users` - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
- `accounts` - OAuth –∞–∫–∫–∞—É–Ω—Ç—ã
- `sessions` - —Å–µ—Å—Å–∏–∏ NextAuth
- `verification_tokens` - —Ç–æ–∫–µ–Ω—ã –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
- `typing_indicators` - –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –ø–µ—á–∞—Ç–∏

---

## üìä –ü—Ä–æ–≤–µ—Ä–∫–∞

### –°–ø–∏—Å–æ–∫ —Ç–∞–±–ª–∏—Ü newsletter:
```sql
\dt newsletter*
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
 newsletter_campaigns   | table | postgres
 newsletter_logs        | table | postgres
 newsletter_subscribers | table | postgres
```
‚úÖ –í—Å–µ —Ç–∞–±–ª–∏—Ü—ã –Ω–∞ –º–µ—Å—Ç–µ!

---

### –°—Ö–µ–º–∞ —Ç–∞–±–ª–∏—Ü—ã newsletter_subscribers:
```sql
SELECT column_name, data_type
FROM information_schema.columns
WHERE table_name = 'newsletter_subscribers';
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** 11 –∫–æ–ª–æ–Ω–æ–∫ ‚úÖ
- id, email, chat_id, verified, verification_code, code_expires_at
- subscribed_at, is_active, language, created_at, updated_at

---

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### 1. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å dev —Å–µ—Ä–≤–µ—Ä
```bash
# –£–±–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å –Ω–∞ –ø–æ—Ä—Ç—É 3000
lsof -ti:3000 | xargs kill -9

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –∑–∞–Ω–æ–≤–æ
npm run dev
```

### 2. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É
1. –û—Ç–∫—Ä—ã—Ç—å —Å–∞–π—Ç
2. –ö–ª–∏–∫–Ω—É—Ç—å "–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —Ä–∞—Å—Å—ã–ª–∫—É"
3. –í–≤–µ—Å—Ç–∏ email
4. –ù–∞–∂–∞—Ç—å "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥"
5. ‚úÖ –î–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å!

### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å email –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ `.env.local` –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã:
```bash
EMAIL_USER=eurocoinfinance@gmail.com
EMAIL_PASSWORD=your_app_password_here
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –î–ª—è Gmail –Ω—É–∂–µ–Ω App Password, –∞ –Ω–µ –æ–±—ã—á–Ω—ã–π –ø–∞—Ä–æ–ª—å!

–ö–∞–∫ —Å–æ–∑–¥–∞—Ç—å App Password:
1. –ü–µ—Ä–µ–π—Ç–∏ –≤ Google Account ‚Üí Security
2. –í–∫–ª—é—á–∏—Ç—å 2FA (–µ—Å–ª–∏ –µ—â–µ –Ω–µ –≤–∫–ª—é—á–µ–Ω–æ)
3. –ü–µ—Ä–µ–π—Ç–∏ –≤ "App passwords"
4. –°–æ–∑–¥–∞—Ç—å –ø–∞—Ä–æ–ª—å –¥–ª—è "Mail"
5. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ—Ç –ø–∞—Ä–æ–ª—å –≤ `EMAIL_PASSWORD`

---

## üìù –ò—Ç–æ–≥–æ–≤—ã–π —á–µ–∫-–ª–∏—Å—Ç

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:
- [x] –ë–∞–∑–∞ `web_wallet_db` —Å–æ–∑–¥–∞–Ω–∞
- [x] –°—Ö–µ–º–∞ `schema.sql` –ø—Ä–∏–º–µ–Ω–µ–Ω–∞
- [x] –°—Ö–µ–º–∞ `newsletter-schema.sql` –ø—Ä–∏–º–µ–Ω–µ–Ω–∞
- [x] –°—Ö–µ–º–∞ `chatbot-schema.sql` –ø—Ä–∏–º–µ–Ω–µ–Ω–∞
- [x] –°—Ö–µ–º–∞ `auth-schema.sql` –ø—Ä–∏–º–µ–Ω–µ–Ω–∞
- [x] –í—Å–µ —Ç–∞–±–ª–∏—Ü—ã –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:
- [x] `DATABASE_URL` –≤ `.env.local` –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π
- [ ] `EMAIL_USER` –Ω–∞—Å—Ç—Ä–æ–µ–Ω (–ø—Ä–æ–≤–µ—Ä–∏—Ç—å)
- [ ] `EMAIL_PASSWORD` –Ω–∞—Å—Ç—Ä–æ–µ–Ω (–ø—Ä–æ–≤–µ—Ä–∏—Ç—å)

### –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:
- [ ] –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å dev —Å–µ—Ä–≤–µ—Ä
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ —Ä–∞—Å—Å—ã–ª–∫—É
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É email

---

## üéØ –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö —à–∞–≥–æ–≤:
1. ‚úÖ API `/api/newsletter/send-code` —Ä–∞–±–æ—Ç–∞–µ—Ç
2. ‚úÖ Email —Å –∫–æ–¥–æ–º –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è
3. ‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î
4. ‚úÖ –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –∫–æ–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
5. ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —Ä–∞—Å—Å—ã–ª–∫—É

---

## üìû –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ "Failed to send email":
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `EMAIL_USER` –∏ `EMAIL_PASSWORD` –≤ `.env.local`
2. –î–ª—è Gmail –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ App Password
3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ 2FA –≤–∫–ª—é—á–µ–Ω–∞ –≤ Google –∞–∫–∫–∞—É–Ω—Ç–µ

### –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ "Database connection":
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ PostgreSQL –∑–∞–ø—É—â–µ–Ω: `pg_isready`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `DATABASE_URL` –≤ `.env.local`
3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–∞—Ä–æ–ª—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π

### –ï—Å–ª–∏ —Ç–∞–±–ª–∏—Ü—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã:
1. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ –ë–î: `psql -U postgres -d web_wallet_db`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–∞–±–ª–∏—Ü—ã: `\dt`
3. –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø—Ä–∏–º–µ–Ω–∏—Ç–µ —Å—Ö–µ–º—ã –∑–∞–Ω–æ–≤–æ

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
**–î–∞—Ç–∞:** 2025-11-11
**–í—Ä–µ–º—è:** ~15 –º–∏–Ω—É—Ç

_–û—Ç—á–µ—Ç —Å–æ–∑–¥–∞–Ω Claude Code_
